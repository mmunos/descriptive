%!TEX root = main.tex

%&$\boldsymbol{\tqfo(\fo)}$ {\bf can be computed in} $\boldsymbol{\shl.}$
First, we show that every formula in $\tqfo(\fo)$ defines a function that is in $\shl$.
Let $\R$ be a relational signature and $\alpha$ a formula over $\R$ in $\tqfo(\fo)$. Next we construct a logarithmic-space nondeterministic Turing Machine $M_{\alpha}$ that on input $(\enc(\A),v)$, where $\A$ is an $\R$-structure and $v$ is a first-order assignment for $\A$, has $\sem{\alpha}(\A,v)$ accepting runs (so that we can conclude that the function defined by $\alpha$ is in $\shl$). Suppose that the domain of $\A$ is $A = \{1,\ldots,n\}$. The TM $M_{\alpha}$ needs $\ell \mult\log_2(n)$ bits of memory to store the first-order variables occurring in $\alpha$, where $\ell$ is the number of variables occurring in this formula (which is the same as the number of variables in the domain of $v$). If $\alpha = \varphi$, where $\varphi$ is an $\fo$-formula, then we check if $(\A,v)\models\varphi$ in deterministic logarithmic space, and accept if and only if this condition holds. If $\alpha = s$, where $s$ is a fixed natural number, then we generate $s$ possible runs and accept in all of them. If $\alpha = (\alpha_1 + \alpha_2)$, we simulate $M_{\alpha_1}$ and $M_{\alpha_2}$ on separate branches. If $\alpha = (\alpha_1\mult\alpha_2)$, we simulate $M_{\alpha_1}$ and if it accepts, then instead of accepting we simulate $M_{\alpha_2}$. If $\alpha = \sa{x}\beta$, for each $a\in A$ we generate a different run where we simulate $M_{\beta}$ with input $v[a/x]$. If $\alpha = \pa{x}\beta$, we simulate $M_{\beta}$ with input $v[1/n]$, and on each accepting run, instead of accepting we replace the assignment of $x$ to 2, to simulate $M_{\beta}$ with input $v[2/x]$, and so on. If $\alpha = [\pth \varphi(\bar{x},\bar{y})]$, where $\varphi$ is an $\fo$-formula, then we simulate the $\shl$ procedure that counts the number of paths of a given length from a source to a target node in an input graph (where the length is at most the number of nodes in the graph).
%This procedure starts by setting $\bar{a} = v(\bar{x})$. On each iteration, it nondeterministically chooses an assignment $\bar{b}$ for $\bar{x}$, and continues if $(\A,v)\models\varphi(\bar{a},\bar{b})$ where $\bar{a}$ is the previously chosen value for $\bar{x}$, and it rejects otherwise. If at any point we obtain that the current value for $\bar x$ is  $\bar{a}$ and $\bar a = v(\bar{y})$, we generate an accepting branch, and continue simulating the procedure in the current branch. We simulate $n^{\length{\bar{x}}}$ iterations of the procedure, and this generates exactly $\sem{[\pth \varphi(\bar{x},\bar{y})]}(\A,v)$ accepting branches. This ends the construction of the algorithm. Consider $f$ as the $\shl$ function associated to this procedure and we have that for each finite $\R$-structure $\A$: $f(\enc(\A)) = \sem{\alpha}(\A)$.

%\vspace{1em}
%$\boldsymbol{\shl}$ {\bf can be modelled in }$\boldsymbol{\tqfo(\fo).}$ 
Second, we show that every function in $\shl$ can be encoded by a formula in $\tqfo(\fo)$.
Let $f$ be a function in $\shl$ and $M$ a logarithmic-space nondeterministic  Turing Machine such that $\tma_M(\enc(\A)) = f(\enc(\A))$. We assume that $M$ has only one accepting state, and that no transition is defined for this state. Moreover, we assume that there exists only one accepting configuration. We make use of transitive closure logic ($\tc$) to simplify our proof~\cite{G07}. We have that $\tc$ captures $\nlog$\cite{I83}, so that there exists a formula $\varphi$ in $\tc$ such that $\A\models\varphi$ if and only if $M$ accepts $\enc(\A)$. This formula can be expressed as:
$$
\varphi = \exists\bar{u}\exists\bar{z}(\first(\bar{u})\wedge \psi_{\bf acc}(\bar{z})\wedge[{\bf tc}_{\bar{x},\bar{y}}\,\psi_{\bf next}(\bar{x},\bar{y})](\bar{u},\bar{z})),
$$
where $\psi_{\bf acc}(\bar{z})$ is an $\fo$-formula that indicates that $\bar{z}$ is an accepting configuration, and $\psi_{\bf next}(\bar{x},\bar{y})$ is an $\fo$-formula that indicates that $\bar{y}$ is a successor configuration of $\bar{x}$~\cite{G07}. Here, there is a one-to-one correspondence between configurations of $M$ and assignments to $\bar{z}$. As a consequence, given a structure $\A$ and a first-order assignment $v$ for $\A$, where $v(\bar{x})$ is the starting configuration and $v(\bar{y})$ is the sole accepting configuration, the value of $\sem{[\pth\psi_{\bf next}(\bar{x},\bar{y})]}(\A,v)$ is equal to $\tma_M(\enc(\A))$.
Therefore, the $\tqfo(\fo)$-formula
$
\alpha = \sa{\bar{u}}\sa{\bar{z}}(\first(\bar{u})\mult\psi_{\bf acc}(\bar{z})\mult[\pth \psi_{\bf next}(\bar{u},\bar{z})])
$
satisfies that $\sem{\alpha}(\A) = f(\enc(\A))$. This concludes the proof of the theorem.