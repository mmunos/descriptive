%!TEX root = main.tex

From now on, for every first-order tuple $\bar{x}$ or second-order tuple $\bar{X}$ we write $\length{\bar{x}}$ or $\length{\bar{X}}$ as the number of variables in $\bar{x}$ or $\bar{X}$ respectively. 
We divide the proof in three parts.

First, we prove that the formula $\alpha_{0} = \left( \sa{X} 1 \right) + 1$ with $\arity(X) = 1$ (i.e. the function $2^{\vert\A\vert}+1$) is not equivalent to any formula in $\loge{0}$-PNF. Suppose that there exists some formula $\alpha = \sa{\bar{X}}\sa{\bar{x}}\varphi(\bar{X},\bar{x})$ in $\loge{0}$-PNF that is equivalent to $\alpha_0$.
In \cite{SalujaST95}, it was proved that if $\length{\bar{X}} > 0$, the function defined by $\alpha$ is always even for big enough structures, which is not possible in our case.
On the other hand, if $\alpha$ is of the form $\sa{\bar{x}}\varphi(\bar{x})$, then $\alpha$ defines a polynomially bounded function which leads to a contradiction.

Second, we prove that the formula $\alpha_{1} = 2$ (i.e. $\sem{\alpha_{1}}$ is the constant function $2$) is not equivalent to any formula in $\loge{1}$-PNF. 
Suppose that there exists some formula $\alpha = \sa{\bar{X}}\sa{\bar{x}}\exists\bar{y}\, \varphi(\bar{X},\bar{x},\bar{y})$ in $\loge{1}$-PNF that is equivalent to $\alpha_1$. 
First, if $\length{\bar{X}} = \length{\bar{x}} = 0$, then the function defined by $\alpha$ is never greater than 1. 
Therefore, suppose that $\length{\bar{X}} > 0$ or $\length{\bar{x}} > 0$, and consider some ordered structure $\A$. 
Since $\sem{\alpha}(\A) = 2$, there exist at least two assignments $(\bar{B}_1,\bar{b}_1,\bar{a}_1)$, $(\bar{B}_2,\bar{b}_2,\bar{a}_2)$ to $(\bar{X},\bar{x},\bar{y})$ such that for $i\in\{1,2\}$: $\A\models\varphi(\bar{B}_i,\bar{b}_i,\bar{a}_i)$. 
Now consider the ordered structure $\A'$ that is obtained by taking the disjoint union of $\A$ twice. 
Indeed, each half of $\A'$ is isomorphic to $\A$. 
Note that $\A'\models\varphi(\bar{B}_i,\bar{b}_i,\bar{a}_i)$ for $i = 1,2$ and there exists a third assignment $(\bar{B}_1',\bar{b}_1',\bar{a}_1')$ that is isomorphic to $(\bar{B}_1,\bar{b}_1,\bar{a}_1)$, in the other half of the structure, such that $\A'\models\varphi(\bar{B}_1',\bar{b}_1',\bar{a}_1')$. 
As a result, we have that $\sem{\alpha}(\A') \geq 3$ which leads to a contradiction.

For the last part of the proof, we show that if $\LL$ contains $\logu{1}$ and is closed under conjunction and disjunction, then for every formula $\alpha$ in $\eqso(\LL)$ there exists an equivalent formula in $\LL$-PNF. 
Similarly as in the proof of Theorem~\ref{theo-pnf-snf}, we show a recursive function $\tau$ that produces such a formula. 
Assume that $\alpha = \sum_{i = 1}^n \alpha_i$ is in $\LL$-SNF where each $\alpha_i$ is in $\LL$-PNF. 
Without loss of generality, we assume that each $\alpha_i = \sa{\bar{X}}\sa{\bar{x}}\varphi_i(\bar{X},\bar{x})$ with $\length{\bar{X}} > 0$ and $\length{\bar{x}} > 0$. 
If that is not the case, we can replace each $\alpha_i$ by the equivalent formula
$$
\sa{\bar{X}} \sa{Y}\sa{\bar{x}}\sa{y}(\varphi_i(\bar{X},\bar{x})\wedge \fa{z} Y(z) \wedge \fa{z} z \leq y).
$$
Now we begin describing the function $\tau$. 
If $\alpha = \sa{\bar{X}}\sa{\bar{x}}\varphi(\bar{X},\bar{x})$, then the formula is already in $\LL$-PNF so we define $\tau(\alpha) = \alpha$. 
If $\alpha = \alpha_1 + \alpha_2$, then we assume that $\tau(\alpha_1) = \sa{\bar{X}}\sa{\bar{x}}\varphi(\bar{X},\bar{x})$ and $\tau(\alpha_2) = \sa{\bar{Y}}\sa{\bar{y}}\psi(\bar{Y},\bar{y})$. 
Our construction works by identifying a ``first'' assignment for both $(\bar{X},\bar{x})$ and $(\bar{Y},\bar{y})$ and a ``last'' assignment for both $(\bar{X},\bar{x})$ and $(\bar{Y},\bar{y})$ using the following formulae:
\begin{align*}
\gamma_{\text{first}}(\bar{X},\bar{x}) & \; = \;  \bigwedge_{i = 1}^{\length{\bar{X}}} \fa{\bar{z}}\neg X_i(\bar{z}) \wedge \fa{\bar{z}}(\bar{x}\leq\bar{z}), \\
\gamma_{\text{last}}(\bar{X},\bar{x}) & \; = \;  \bigwedge_{i = 1}^{\length{\bar{X}}} \fa{\bar{z}} X_i(\bar{z}) \wedge \fa{\bar{z}}(\bar{z}\leq\bar{x}).
\end{align*}
Similarly, we can define the formulae $\gamma_{\text{first}}(\bar{Y},\bar{y})$ and $\gamma_{\text{last}}(\bar{Y},\bar{y})$.
In other words, the ``first'' assignment is the one where every second-order predicate is empty and the first-order assignment is the lexicographically smallest, and the ``last'' assignment is the one where every second-order predicate is full and the first-order assignment is the lexicographically greatest. 
We also need to identify the assignments that are not first and the ones that are not last. 
We do this by negating the two formulae above and grouping together the first-order variables:
\begin{align*}
\gamma_{\text{not-first}}(\bar{X},\bar{x}) & \; = \; \ex{\bar{z}}(\bar{z}_0 < \bar{x} \vee \bigvee_{i = 1}^{\length{\bar{X}}}X(\bar{z}_i)), \\
\gamma_{\text{not-last}}(\bar{X},\bar{x}) & \; = \; \ex{\bar{z}}(\bar{x} < \bar{z}_0 \vee \bigvee_{i = 1}^{\length{\bar{X}}}\neg X(\bar{z}_i)),
\end{align*}
where $\bar{z} = (\bar{z}_0,\bar{z}_1,\ldots,\bar{z}_{\length{\bar{X}}})$. Then the following formula is equivalent to $\alpha$:
\begin{align}
\sa{\bar{X}}\sa{\bar{x}}\sa{\bar{Y}}\sa{\bar{y}}[&(\varphi(\bar{X},\bar{x})\wedge\gamma_{\text{not-first}}(\bar{X},\bar{x})\wedge\gamma_{\text{first}}(\bar{Y},\bar{y}))\vee \label{eq:partition1} \\
&(\varphi(\bar{X},\bar{x})\wedge\gamma_{\text{first}}(\bar{X},\bar{x})\wedge\gamma_{\text{last}}(\bar{Y},\bar{y}))\vee \label{eq:partition2}\\
&(\psi(\bar{Y},\bar{y})\wedge\gamma_{\text{first}}(\bar{X},\bar{x})\wedge\gamma_{\text{not-last}}(\bar{Y},\bar{y}))\vee \label{eq:partition3}\\
&(\psi(\bar{Y},\bar{y})\wedge\gamma_{\text{last}}(\bar{X},\bar{x})\wedge\gamma_{\text{last}}(\bar{Y},\bar{y}))]. \label{eq:partition4}
\end{align}

To show that the formula is indeed equivalent to $\alpha$, note that the formulae in lines (\ref{eq:partition1}) and (\ref{eq:partition2}) form a partition over the assignments of $(\bar{X},\bar{x})$, while fixing an assignment for $(\bar{Y},\bar{y})$, and the formulae in lines (\ref{eq:partition3}) and (\ref{eq:partition4}) form a partition over the assignments of $(\bar{Y},\bar{y})$, while fixing an assignment for $(\bar{X},\bar{x})$. 
Altogether the four lines define pairwise disjoint assignments for $(\bar{X},\bar{x}),(\bar{Y},\bar{y})$. 
With this, it is straightforward to show that the above formula is equivalent to $\alpha$. 
However, the formula is not yet in the correct form since it has existential quantifiers in the sub-formulae $\gamma_{\text{not-first}}$ and $\gamma_{\text{not-last}}$. 
To solve this, we can replace each existential quantifier by a first order sum that counts just the first assignment that satisfies the inner formula and this can be defined in $\logu{1}$. 
A similar construction was used in \cite{SalujaST95}. 

Finally, consider a $\eqso(\LL)$ formula $\alpha$ in $\LL$-SNF. 
If $\alpha = \sum_{i = 1}^n\alpha_i$, then by induction we consider $\alpha = \alpha_1 + (\sum_{i = 2}^n\alpha_i)$ and use $\tau(\alpha_1 + \tau(\sum_{i = 2}^n\alpha_i))$ as the rewrite of $\alpha$, which satisfies the hypothesis.
%To show that the formula is indeed equivalent to $\alpha$, note that the formulas in lines (\ref{eq:partition1}) and (\ref{eq:partition2}) form a partition over the assignments of $(\bar{X},\bar{x})$, while fixing an assignment for $(\bar{Y},\bar{y})$, and the formulas in lines (\ref{eq:partition3}) and (\ref{eq:partition4}) form a partition over the assignments of $(\bar{Y},\bar{y})$, while fixing an assignment for $(\bar{X},\bar{x})$. Altogether, the four lines define pairwise disjoint assignments for $(\bar{X},\bar{x}),(\bar{Y},\bar{y})$. With this, it is straightforward to show that the above formula is equivalent to $\alpha$. However, the formula is not yet in the correct form since it has existential quantifiers in the sub-formulas $\gamma_{\text{not-first}}$ and $\gamma_{\text{not-last}}$. To solve this, first let us take a close look to the complete formula:
%\begin{align*}
%\sa{\bar{X}}\sa{\bar{x}}\sa{\bar{Y}}\sa{\bar{y}}[&(\varphi(\bar{X},\bar{x})\wedge\exists\bar{v}(\bar{v}_0 < \bar{x} \vee \bigvee_{i = 1}^{\length{\bar{X}}}X(\bar{v}_i))\wedge\bigwedge_{i = 1}^{\length{\bar{Y}}} \forall\bar{z}\neg Y_i(\bar{z}) \wedge \forall\bar{z}(\bar{y}\leq\bar{z}))\vee\\
%&(\varphi(\bar{X},\bar{x})\wedge\bigwedge_{i = 1}^{\length{\bar{X}}} \forall\bar{z}\neg X_i(\bar{z}) \wedge \forall\bar{z}(\bar{x}\leq\bar{z})\wedge\bigwedge_{i = 1}^{\length{\bar{Y}}} \forall\bar{z} Y_i(\bar{z}) \wedge \forall\bar{z}(\bar{z}\leq\bar{y}))\vee\\
%&(\psi(\bar{Y},\bar{y})\wedge\bigwedge_{i = 1}^{\length{\bar{X}}} \forall\bar{z}\neg X_i(\bar{z}) \wedge \forall\bar{z}(\bar{x}\leq\bar{z})\wedge\exists\bar{w}(\bar{y} < \bar{w}_0 \vee \bigvee_{i = 1}^{\length{\bar{Y}}}\neg Y(\bar{w}_i))\vee\\
%&(\psi(\bar{Y},\bar{y})\wedge\bigwedge_{i = 1}^{\length{\bar{X}}} \forall\bar{z} X_i(\bar{z}) \wedge \forall\bar{z}(\bar{z}\leq\bar{x})\wedge\bigwedge_{i = 1}^{\length{\bar{Y}}} \forall\bar{z} Y_i(\bar{z}) \wedge \forall\bar{z}(\bar{z}\leq\bar{y}))].
%\end{align*}
%To construct an equivalent formula that is in the correct form, we define $\bar{u} = (\bar{v},\bar{w})$ and we replace the first-order quantifiers by a first-sum and count the first assignment to $\bar{v}$ and $\bar{w}$ that satisfies the formula. A similar construction was used in \cite{SalujaST95}. Then the final formula equivalent to $\alpha$ is the following:
%\begin{align*}
%\sa{\bar{X}}&\sa{\bar{Y}}\sa{\bar{x}}\sa{\bar{y}}\sa{\bar{u}}\big[ \\
%&[\varphi(\bar{X},\bar{x})\wedge(\bar{v}_0 < \bar{x} \vee \bigvee_{i = 1}^{\length{\bar{X}}}X(\bar{v}_i))\wedge \forall\bar{u}'((\bar{v}_0' < \bar{x} \vee \bigvee_{i = 1}^{\length{\bar{X}}}X(\bar{v}_i'))\to\bar{u}\leq\bar{u}') \wedge \\
%&\bigwedge_{i = 1}^{\length{\bar{Y}}} \forall\bar{z}\neg Y_i(\bar{z}) \wedge \forall\bar{z}(\bar{y}\leq\bar{z})]\vee\\
%&
%[\varphi(\bar{X},\bar{x})\wedge\bigwedge_{i = 1}^{\length{\bar{X}}} \forall\bar{z}\neg X_i(\bar{z}) \wedge \forall\bar{z}(\bar{x}\leq\bar{z})\wedge\bigwedge_{i = 1}^{\length{\bar{Y}}} \forall\bar{z} Y_i(\bar{z}) \wedge \forall\bar{z}(\bar{z}\leq\bar{y})\wedge\forall\bar{u}'(\bar{u}\leq\bar{u}')]\vee
%\\
%&[\psi(\bar{Y},\bar{y})\wedge\bigwedge_{i = 1}^{\length{\bar{X}}} \forall\bar{z}\neg X_i(\bar{z}) \wedge \forall\bar{z}(\bar{x}\leq\bar{z})\wedge \\
%&(\bar{y} < \bar{w}_0 \vee \bigvee_{i = 1}^{\length{\bar{Y}}}\neg Y(\bar{w}_i))\wedge\forall\bar{u}'(\bar{y} < \bar{w}_0' \vee \bigvee_{i = 1}^{\length{\bar{Y}}}\neg Y(\bar{w}_i'))\to\bar{u}\leq\bar{u}']\vee \\
%&[\psi(\bar{Y},\bar{y})\wedge\bigwedge_{i = 1}^{\length{\bar{X}}} \forall\bar{z} X_i(\bar{z}) \wedge \forall\bar{z}(\bar{z}\leq\bar{x})\wedge\bigwedge_{i = 1}^{\length{\bar{Y}}} \forall\bar{z} Y_i(\bar{z}) \wedge \forall\bar{z}(\bar{z}\leq\bar{y})\wedge\forall\bar{u}'(\bar{u}\leq\bar{u}')]\big].
%\end{align*}
%
%Finally, consider a $\eqso(\LL)$ formula $\alpha$ in $\LL$-SNF. If $\alpha = \sum_{i = 1}^n\alpha_i$, then by induction we can consider $\alpha = \alpha_1 + (\sum_{i = 2}^n\alpha_i)$ and use $\tau(\alpha_1 + \tau(\sum_{i = 2}^n\alpha_i))$ as the rewrite of $\alpha$, which satisfies the hypothesis.
