
Assume that $\alpha$ is a sentence in $\qso$. Then slightly abusing notation, we also use $\alpha$ to denote a function from $\R$ to $\bbN$ such that for every $\A \in \str[\R] $:
\begin{eqnarray*}
\alpha(\enc(\A)) & = & \sem{\alpha}(\A).
\end{eqnarray*}
\begin{definition}
Let $\FF$ a fragment of $\qso$, $\CC$ a function complexity class over $\bbN$ and $\KK$ a class of finite structures. Then $\FF$ {\em captures} $\CC$ over $\KK$ if:
\begin{itemize}
\item for every $\alpha$ in $\FF$, there exists $f \in \CC$ such that $\res{\alpha}{\KK} = \res{f}{\KK}$; and

\item for every $f \in \CC$, there exists $\alpha$ in $\FF$ such that $\res{f}{\KK} = \res{\alpha}{\KK}$.
\end{itemize}
\end{definition}
In the previous definition, if $\KK$ is the class of all finite structures, then we say that $\FF$ captures $\CC$ over the class of all structures, and if $\KK$is the class of all ordered finite structures, then we say that $\FF$ captures $\CC$ over the class of ordered structures. 

\cristian{Aca hay que definir esto sobre estructuras finitas directamente. No veo el sentido de tener estructuras infinitas.}

\begin{theorem} \label{captfp}
	$\qfo(\lfp)$ captures $\fp$ over the class of ordered structures.
\end{theorem}
\begin{proof}
	For the first condition, let $\alpha\in\qfo(\lfp)$, $\A\in\ostr$, $v$ and $V$ a first and second order assignment for $\A$, respectively. To evaluate $\sem{\alpha}(\A,v,V)$, we replace each first order sum and first order product by their corresponding expansion. This is, $\Sigma x \beta(x)$ is replaced by $(\beta(a_1)+\cdots+\beta(a_n))$, where $A = \{a_1,\ldots,a_n\}$, and $\Pi x \beta(x)$ is replaced by $(\beta(a_1)\cdot\,\cdots\,\cdot\beta(a_n))$. Then we replace each logic sub-formula $\varphi$ in $\alpha$ by their evaluated value, 0 or 1. Since each of this formulas is in $\lfp$, this can be done in polynomial time. The resulting formula is an arithmetic expression, which can be evaluated recursively in polynomial time.
	
	For the second condition, let $f\in \fp$. Let $k\in\nat$ be such that $\vert f(\A) \vert = \vert A \vert^k$ for each $\A\in\ostr[\R]$. Let $\Phi(x_0,\ldots,x_{k-1})$ be a $\lfp$ formula such that $(\A,a_0,\ldots,a_{k-1})\models\Phi$ if and only if in the string $y = f(\A)$ there is 1 in the $(\vert A \vert^{k-1}m_{k-1} + \cdots + \vert A \vert^2 m_2 + \vert A \vert m_1 + m_0)$-th position from right to left, and where $a_i$ is the (0-indexed) $m_i$-th element of $A$. We use
	$$
	\alpha = \Sigma x_0 \cdots \Sigma x_{k-1} \Phi(x_0,\ldots,x_{k-1})\cdot\varphi_{k-1}(x_{k-1})\cdot\,\cdots\,\cdot\varphi_0(x_0).
	$$
	where $\varphi_i(x) = \Pi y[(y < x)\mapsto\Pi z_1\cdots\Pi z_i\,2]$ for $i > 0$ and $\varphi_0(x) = \Pi y[(y < x)\mapsto 2]$. Note that if $a$ is the  $m$-th element in $A$, then $\sem{\varphi_i(x)}(\A,a) = 2^{\vert A \vert^i m}$. Therefore, for each $(a_0,\ldots,a_{k-1})\in A^k$, we have that $\sem{\Phi(x_0,\ldots,x_{k-1})\cdot\varphi_{k-1}(x_{k-1})\,\cdots\,\varphi_0(x_0)}(\A,a_0,\ldots,a_{k-1}) = 2^{(\vert A \vert^{k-1}m_{k-1} + \cdots + \vert A \vert^2 m_2 + \vert A \vert m_1 + m_0)}$ if $(\A,a_0,\ldots,a_{k-1})\models\Phi$ and 0 otherwise, and adding these values gives $f(\A)$. 	
\end{proof}

\begin{theorem}
	$\qfo(\pfp)$ captures $\nfpspace$ over the class of ordered structures.
\end{theorem}
\begin{proof}
	For the first condition, we use the exact same procedure as in Theorem \ref{captfp}, noting that evaluating each of the $\pfp$ formulas can be done in polynomial space, and that the result is also polynomial on the size of the input.
	
	For the second condition, note that for each function $f\in \nfpspace$, $\vert f(\A) \vert$ is polynomial on $\vert A \vert$. Thus, there is a $\pfp$ formula $\Phi$ that models the string $f(\A)$ by the bit. The rest of the proof is analogous to Theorem \ref{captfp}.
\end{proof}

\begin{theorem}
	$\qfo(\tc)$ captures $\shl$ over the class of ordered structures.
\end{theorem}
\begin{proof}
	For the first condition, let $\alpha\in\qfo(\tc)$, let $\A\in\ostr$ $v$ and $V$ first and second order assignments of $\A$ respectively. We evaluate $\sem{\alpha}(\A,v,V)$ recursively. A logic formula $\varphi$ is evaluated...?
	
	For the second condition, note that for each function $f\in \shl$, $\vert f(\A) \vert$ is polynomial on $\vert A \vert$. Thus, there is a $\tc$ formula $\Phi$ that models the string $f(\A)$ by the bit. The rest of the proof is analogous to Theorem \ref{captfp}.
\end{proof}

\begin{theorem}
	$\rqfo(\fo)$ captures $\fp$ over the class of ordered structures.
\end{theorem}

\begin{theorem}
	$\tqfo(\fo)$ captures $\shl$ over the class of ordered structures.
\end{theorem}
\begin{proof}
	For the second condition, let $f \in \shl$. We will address the case where $\R$ contains only one binary predicate $E$, and the rest of the cases can be deduced from this. Let $M$ be a non-deterministic logspace machine such that $f(\A) = \acc_M(\A)$ for each $\A \in \ostr[R]$. Suppose ${\cal Q} = \{q_1,\ldots,q_{\ell}\}$ is the set of states of $M$, where $q_1$ is the initial state, and $q_{\ell}$ is only final state of $M$. Let $n = \vert A \vert$ and let $w = \enc(\A) \in \{0,1\}^{n^2}$. We assume that $M$ with input $w$ uses space $s_M(w) < c\cdot\log(n)$ and furthermore, $s_M(w) < n-2$. We notate $M(w)$ as the graph of configurations of $M$ running on input $w$.
	
	We represent configurations with a tuple of fixed size $k$. The formula $\varphi(\bar{x},\bar{y})$ describes a procedure that given a configuration generates a possible next configuration. The formula $\varphi_I(\bar{x})$ models that $\bar{x}$ is the initial configuration of $M(w)$. The formula $\varphi_F(\bar{x})$ models that $\bar{x}$ is an accepting (final) configuration of $M(w)$. The formula we construct is:
	$$
	\alpha = \sa{\bar{x}}\sa{\bar{y}}([\pth \varphi(\bar{u},\bar{v})](\bar{x},\bar{y})\cdot \varphi_I(\bar{x})\cdot\varphi_F(\bar{y})).
	$$
	
	To illustrate our idea, we will show a greatly simplified example. Consider a machine $M$ that works in exactly $\log_2(n)$ space and only allows 0 or 1 in the working tape. Consider an input $\A$ of size 16 (that is, $A = \{0,\ldots,9,A,\ldots,F\}$). Let some configuration $s$ have 0011 in the working tape, the head in the input tape is in position 26, and the head in the input tape is in position 2 (we consider 0-indexed positions). Also, $Q = \{q_1,\ldots,q_5\}$ and the current state is $q_3$.
	
	As a first approach, we will use a 9-tuple $\bar{a} = (a_1,\ldots,a_9)$ to represent $s$. That is, $(a_1,a_2) = (1,A)$ represent the position of the head in the input tape, $a_3 = 2$ represents the position of the head in the working tape, $a_4 = C$ (1100b in base 16) represents the content of the working tape, and $(a_5,\ldots,a_9) = (0,0,1,0,0)$ represents the current state. Then $\bar{a} = (1,A,2,C,0,0,1,0,0)$ will represent $s$. It is not possible \martin{no se si ser\'a cierto esto} to find the $i$-th bit of an element $x$, or much less switch the $i$-th bit of an element, solely with $\fo$. So consider the following procedure.
	
	\begin{algorithm}
	\caption{If the $i$-th bit in $x$ is 1 replace it by 0}
	\begin{algorithmic}
		\State $b \gets bit(x,i)$
		\State $\textbf{assert } b = 1$
		\State $y = pow2(i)$
		\State $z = substract(x,y)$
		\State \Return $z$.
	\end{algorithmic}
	\end{algorithm}	
	And the details for $bit$, $pow2$ and $substract$ are left for the reader as an exercise.
	
	Note that there is an upper bound of $(n^2+2)\cdot (c\log(n)+2)\cdot 3^{c\log n} \cdot \ell$ distinct configurations in $M(w)$. Given a configuration $s\in M(w)$, we construct a tuple $\bar{a} = (a_0,\ldots,a_{k-1})$ that represents $s$.
	\begin{itemize}
	\item $(a_0,a_1,a_2)$ represent the position of the head in the reading tape. If $a_0 = 1$, then the head is in position $a_1a_2$ (the $a_1a_2$-th character in the input). If $a_1 = 2$, then $a_2 = 1$ represents that the head is at the beginning of the tape (position 0), and if $a_2 = 2$, then the head is at position $n+1$.
	\item $a_3$ represents the position of the head in the working tape.
	\item $(a_4,\ldots,a_{3+2c})$ represents the string that is in the working tape. Specifically, let $h$ be the value of $a_{3+2c}a_{2+2c}\cdots a_{5}a_{4}$ in base $n$. Then the string in the working tape is $h$ in base 3, where 2 is interpreted as $\texttt{B}$.
	\item $(a_{4+2c},\ldots,a_{3+2c+\ell})$ represents the current state $q_i$. Every value in the tuple is $1$ except the element $a_{3+2c+i}$ which is 2.	
	\end{itemize}
	
	
	Now we describe the formulas.
	\begin{align*}
	\varphi_I(\bar{x}) &= \varphi_v(\bar{x}) \wedge \exists u(\varphi_1(u) \wedge \varphi_{succ}(u,x_{3+e+2c})), \\
	\varphi_F(\bar{x}) &= \varphi_v(\bar{x}) \wedge \exists u(\varphi_1(u) \wedge \varphi_{succ}(u,x_{2+e+2c+\ell})),
	\end{align*}
	where $\varphi_v(\bar{x})$ describes that $\bar{x}$ is a valid configuration of $M(w)$ and $\varphi_1(x)$ describes that $x$ is the first element of $A$.
	\begin{align*}
	\varphi_v^1(\bar{x}) &= \exists u(\varphi_1(u) \wedge (x_1 = u \vee \varphi_{succ}(u,x_1)) \wedge \varphi_{succ}(u,x_1) \to (x_2 = u \vee \varphi_{succ}(u,x_2))), \\
	\varphi_v^4(\bar{x}) &= \exists u(\varphi_1(u) \wedge \bigvee_{i = 1}^{\ell}(\varphi_{succ}(u,x_{2+e+2c+i})  \wedge \bigwedge\limits_{\substack{i = 1\\ j \neq i}}^{\ell} x_{2+e+2c+j} = u)).
	\end{align*}
\end{proof}

\begin{theorem}
	$\tqso(\fo)$ captures $\shp$ over the class of ordered structures.
\end{theorem}

\begin{theorem}
	($\qfo(\lfp)$ or $\qfo(\fo)$) with algebraic least fixed point operator captures $\totp$ over the class of ordered structures.
\end{theorem}
	

\begin{theorem}
$\eqso(\fo)$ captures $\shp$ over the class of ordered structures.
\end{theorem}

\begin{proposition}
$\eqso(\fo)$ does not capture $\shp$ over the class of all structures.
\end{proposition}

%\begin{theorem}
%$\eqso(\integ,\fo)$ captures $\gp$ over the class of ordered structures.
%\end{theorem}


\begin{theorem}
$\eqso(\eso)$ captures $\spp$ over the class of ordered structures.
\end{theorem}
