\subsection*{Proof of Theorem \ref{theo-pnf-snf}}
Recall that a formula in $\eqso(\LL)$ is on the following grammar:
$$
\alpha = \varphi \ \mid \ s \ \mid \ (\alpha + \alpha) \ \mid \ \sa{x} \alpha \ \mid \ \sa{X} \alpha,
$$
where $\varphi$ is a formula in $\LL$ and $s\in\nat$. We will construct a recursive function $\tau$ such that for every $\eqso(\LL)$ formula $\alpha$, it outputs an equivalent formula $\tau(\alpha)$ which is in $\LL$-SNF. If $\alpha = \varphi$, then we define $\tau(\alpha) = \alpha$ which is clearly equivalent and already in $\LL$-SNF. If $\alpha = s$, then we define $(\top \add \cdots \add \top)$ ($s$ times), which also satisfies the condition. We assume that for every sub-formula $\beta$ of $\alpha$, $\tau(\beta)$ is an equivalent formula in $\LL$-SNF. If $\alpha = (\alpha_1 + \alpha_2)$, then we define $\tau(\alpha) = (\tau(\alpha_1) + \tau(\alpha_2))$. If $\alpha = \sa{x}\beta$, then let $\tau(\beta) = \sum_{i = 1}^{k}\beta_i$ for some $k$ where each $\beta_i$ is in $\LL$-PNF. By grouping together the terms in the sum, we define $\tau(\alpha) = \sum_{i = 1}^{m}\sa{x}\beta_i$ which satisfies the condition and is equivalent to $\alpha$. If $\alpha = \sa{X}\beta$, then we proceed analogously as in the previous case. This covers all possible cases for $\alpha$ and we conclude the proof by taking $\tau(\alpha)$ as the desired rewrite of $\alpha$.












\subsection*{Proof of theorem \ref{theo-pi1-pnf}}
We divide the proof in three parts.

\vspace{1em}
First, we prove that the formula $\alpha_{0} = \left( \sa{X} 1 \right) + 1$ with $\arity(X) = 1$ (i.e. the function $2^{n}+1$, where $n$ is the size of the input structure) is not equivalent to any formula in $\loge{0}$-PNF. Suppose that there exists some formula $\alpha = \sa{\bar{X}}\sa{\bar{x}}\varphi(\bar{X},\bar{x})$ in $\loge{0}$-PNF that is equivalent to the $\eqso(\loge{0})$ formula $\alpha_0$.
In \cite{SalujaST95}, it was proved that if $\length(\bar{X}) > 0$, then the function defined by $\alpha$, for big enough structures, is always even which is not possible in our case.
On the other hand, if $\alpha$ is of the form $\sa{\bar{x}}\varphi(\bar{x})$, then $\alpha$ defines a polynomially bounded function which also leads to a contradiction.

\vspace{1em}
Second, we prove that the formula $\alpha_{1} = 2$ (i.e. the constant $2$) is not equivalent to any formula in $\loge{1}$-PNF. Suppose that there exists some formula $\alpha = \sa{\bar{X}}\sa{\bar{x}}\exists\bar{y}\, \varphi(\bar{X},\bar{x},\bar{y})$ in $\loge{1}$-PNF that is equivalent to the $\eqso(\loge{1})$ formula $2$. 
First, if $\length(\bar{X}) = \length(\bar{x}) = 0$, then the function defined by $\alpha$ is never greater than 1. 
Therefore, suppose that $\length(\bar{X}) > 0$ or $\length(\bar{x}) > 0$, and consider any ordered structure $\A$. 
Since $\sem{\alpha}(\A) = 2$, there exist at least two assignments $(\bar{B}_1,\bar{b}_1,\bar{a}_1)$, $(\bar{B}_2,\bar{b}_2,\bar{a}_2)$ to $(\bar{X},\bar{x},\bar{y})$ such that for both, $\A\models\varphi(\bar{B}_i,\bar{b}_i,\bar{a}_i)$. Now consider the ordered structure $\A'$ that is obtained by duplicating $\A$. This is, each half of $\A'$ is isomorphic to $\A$. Note that $\A'\models\varphi(\bar{B}_i,\bar{b}_i,\bar{a}_i)$ for $i = 1,2$ and there exists a third assignments $(\bar{B}_1',\bar{b}_1',\bar{a}_1')$ that is isomorphic to $(\bar{B}_1,\bar{b}_1,\bar{a}_1)$ but in the other half to the structure such that $\A'\models\varphi(\bar{B}_1',\bar{b}_1',\bar{a}_1')$. We have that $\sem{\alpha}(\A) \geq 3$ which is a contradiction.

\vspace{1em}
We now show that if $\LL$ contains $\logu{1}$ and is closed under conjunction and disjunction, then for every formula $\alpha$ in $\eqso(\LL)$ there is an equivalent formula $\beta$ in $\LL$-PNF. As in Theorem \ref{theo-pnf-snf}, we show a recursive function $\tau$ that produces such formula. As we showed, there exists an equivalent formula in $\LL$-SNF, so we assume that $\alpha$ is in that form. Let $\alpha = \sum_{i = 1}^n \alpha_i$ where each $\alpha_i$ is in $\LL$-SNF. 
Without lost of generality, we assume that each $\alpha_i = \sa{\bar{X}}\sa{\bar{x}}\varphi_i(\bar{X},\bar{x})$ with $\length(\bar{X}) > 0$ and $\length(\bar{x}) > 0$. If not, we replace each $\alpha_i$ for the equivalent formula $\sa{\bar{X}} \sa{Y}\sa{\bar{x}}\sa{y}(\varphi_i(\bar{X},\bar{x})\wedge\forall z\,Y(z) \wedge \forall z(y \leq z))$.

Now we begin describing the function $\tau$. If $\alpha = \sa{\bar{X}}\sa{\bar{x}}\varphi(\bar{X},\bar{x})$, then the formula is already in $\LL$-PNF so we define $\tau(\alpha) = \alpha$. If $\alpha = \alpha_1 + \alpha_2$, then we assume that $\tau(\alpha_1) = \sa{\bar{X}}\sa{\bar{x}}\varphi(\bar{X},\bar{x})$ and $\tau(\alpha_2) = \sa{\bar{Y}}\sa{\bar{y}}\psi(\bar{Y},\bar{y})$. The construction that we will provide for this function works by identifying a ``first'' assignment for both $(\bar{X},\bar{x})$ and $(\bar{Y},\bar{y})$ and a ``last'' assignment for both $(\bar{X},\bar{x})$ and $(\bar{Y},\bar{y})$. These are identified by the following formulas:
\begin{align*}
\gamma_{\text{first}}(\bar{X},\bar{x}) &= \bigwedge_{i = 1}^{\length(\bar{X})} \forall\bar{z}\neg X_i(\bar{z}) \wedge \forall\bar{z}(\bar{x}\leq\bar{z}), \\
\gamma_{\text{last}}(\bar{X},\bar{x}) &= \bigwedge_{i = 1}^{\length(\bar{X})} \forall\bar{z} X_i(\bar{z}) \wedge \forall\bar{z}(\bar{z}\leq\bar{x}).
\end{align*}
Similarly, we define the formulas $\gamma_{\text{first}}(\bar{Y},\bar{y})$ and $\gamma_{\text{last}}(\bar{Y},\bar{y})$ (for the sake of simplicity we reuse the names $\gamma_{\text{first}}$ and $\gamma_{\text{last}}$).
In other words, the ``first'' assignment is the one where every second-order predicate is empty and the first-order assignment is the lexicographically smallest, and the ``last'' assignment is the one where every second-order predicate is full and the first-order assignment is the lexicographically greatest. We also need to identify assignments that are not first and are not last. We do this by negating the two formulas above and grouping together the first-order variables:
\begin{align*}
\gamma_{\text{not first}}(\bar{X},\bar{x}) &= \exists\bar{z}(\bar{z}_0 < \bar{x} \vee \bigvee_{i = 1}^{\length(\bar{X})}X(\bar{z}_i)), \\
\gamma_{\text{not last}}(\bar{X},\bar{x}) &= \exists\bar{z}(\bar{x} < \bar{z}_0 \vee \bigvee_{i = 1}^{\length(\bar{X})}\neg X(\bar{z}_i)),
\end{align*}
where $\bar{z} = (\bar{z}_0,\bar{z}_1,\ldots,\bar{z}_{\length(\bar{X})})$. The following formula is equivalent to $\alpha$:
\begin{align}
\sa{\bar{X}}\sa{\bar{x}}\sa{\bar{Y}}\sa{\bar{y}}[&(\varphi(\bar{X},\bar{x})\wedge\gamma_{\text{not first}}(\bar{X},\bar{x})\wedge\gamma_{\text{first}}(\bar{Y},\bar{y}))\vee \label{eq:partition1} \\
&(\varphi(\bar{X},\bar{x})\wedge\gamma_{\text{first}}(\bar{X},\bar{x})\wedge\gamma_{\text{last}}(\bar{Y},\bar{y}))\vee \label{eq:partition2}\\
&(\psi(\bar{Y},\bar{y})\wedge\gamma_{\text{first}}(\bar{X},\bar{x})\wedge\gamma_{\text{not last}}(\bar{Y},\bar{y}))\vee \label{eq:partition3}\\
&(\psi(\bar{Y},\bar{y})\wedge\gamma_{\text{last}}(\bar{X},\bar{x})\wedge\gamma_{\text{last}}(\bar{Y},\bar{y}))]. \label{eq:partition4}
\end{align}
To show that the formula is indeed equivalent to $\alpha$, note that the formulas in lines (\ref{eq:partition1}) and (\ref{eq:partition2}) form a partition over the assignments of $(\bar{X},\bar{x})$, while fixing an assignment for $(\bar{Y},\bar{y})$, and the formulas in lines (\ref{eq:partition3}) and (\ref{eq:partition4}) form a partition over the assignments of $(\bar{Y},\bar{y})$, while fixing an assignment for $(\bar{X},\bar{x})$. Altogether, the four lines define pairwise disjoint assignments for $(\bar{X},\bar{x}),(\bar{Y},\bar{y})$. With this, it is straightforward to show that the above formula is equivalent to $\alpha$. However, the formula is not yet in the correct form since it has existential quantifiers in the subformulas $\gamma_{\text{not first}}$ and $\gamma_{\text{not last}}$. To solve this, first let take a close look to the complete formula:
\begin{align*}
\sa{\bar{X}}\sa{\bar{x}}\sa{\bar{Y}}\sa{\bar{y}}[&(\varphi(\bar{X},\bar{x})\wedge\exists\bar{v}(\bar{v}_0 < \bar{x} \vee \bigvee_{i = 1}^{\length(\bar{X})}X(\bar{v}_i))\wedge\bigwedge_{i = 1}^{\length(\bar{Y})} \forall\bar{z}\neg Y_i(\bar{z}) \wedge \forall\bar{z}(\bar{y}\leq\bar{z})\vee\\
&(\varphi(\bar{X},\bar{x})\wedge\bigwedge_{i = 1}^{\length(\bar{X})} \forall\bar{z}\neg X_i(\bar{z}) \wedge \forall\bar{z}(\bar{x}\leq\bar{z})\wedge\bigwedge_{i = 1}^{\length(\bar{Y})} \forall\bar{z} Y_i(\bar{z}) \wedge \forall\bar{z}(\bar{z}\leq\bar{y}))\vee\\
&(\psi(\bar{Y},\bar{y})\wedge\bigwedge_{i = 1}^{\length(\bar{X})} \forall\bar{z}\neg X_i(\bar{z}) \wedge \forall\bar{z}(\bar{x}\leq\bar{z})\wedge\exists\bar{w}(\bar{y} < \bar{w}_0 \vee \bigvee_{i = 1}^{\length(\bar{Y})}\neg Y(\bar{w}_i))\vee\\
&(\psi(\bar{Y},\bar{y})\wedge\bigwedge_{i = 1}^{\length(\bar{X})} \forall\bar{z} X_i(\bar{z}) \wedge \forall\bar{z}(\bar{z}\leq\bar{x})\wedge\bigwedge_{i = 1}^{\length(\bar{Y})} \forall\bar{z} Y_i(\bar{z}) \wedge \forall\bar{z}(\bar{z}\leq\bar{y}))].
\end{align*}
To construct an equivalent formula that is in the correct form, we define $\bar{u} = (\bar{v},\bar{w})$ and we replace the first-order quantifiers by a first-sum and count the first assignment to $\bar{v}$ and $\bar{w}$ that satisfies the formula. A similar construction was used in \cite{SalujaST95}. Then the final formula equivalent to $\alpha$ is the following:
\begin{align*}
\sa{\bar{X}}\sa{\bar{Y}}\sa{\bar{x}}\sa{\bar{y}}\sa{\bar{u}}[&(\varphi(\bar{X},\bar{x})\wedge(\bar{v}_0 < \bar{x} \vee \bigvee_{i = 1}^{\length(\bar{X})}X(\bar{v}_i))\wedge \forall\bar{u}'((\bar{v}_0' < \bar{x} \vee \bigvee_{i = 1}^{\length(\bar{X})}X(\bar{v}_i'))\to\bar{u}\leq\bar{u}') \wedge \\
& \hspace{3cm}  \bigwedge_{i = 1}^{\length(\bar{Y})} \forall\bar{z}\neg Y_i(\bar{z}) \wedge \forall\bar{z}(\bar{y}\leq\bar{z})\vee\\
&
(\varphi(\bar{X},\bar{x})\wedge\bigwedge_{i = 1}^{\length(\bar{X})} \forall\bar{z}\neg X_i(\bar{z}) \wedge \forall\bar{z}(\bar{x}\leq\bar{z})\wedge\bigwedge_{i = 1}^{\length(\bar{Y})} \forall\bar{z} Y_i(\bar{z}) \wedge \forall\bar{z}(\bar{z}\leq\bar{y})\wedge\forall\bar{u}'(\bar{u}\leq\bar{u}'))\vee
\\
&(\psi(\bar{Y},\bar{y})\wedge\bigwedge_{i = 1}^{\length(\bar{X})} \forall\bar{z}\neg X_i(\bar{z}) \wedge \forall\bar{z}(\bar{x}\leq\bar{z})\wedge \\
& \hspace{3cm} (\bar{y} < \bar{w}_0 \vee \bigvee_{i = 1}^{\length(\bar{Y})}\neg Y(\bar{w}_i))\wedge\forall\bar{u}'(\bar{y} < \bar{w}_0' \vee \bigvee_{i = 1}^{\length(\bar{Y})}\neg Y(\bar{w}_i'))\to\bar{u}\leq\bar{u}')\vee \\
&(\psi(\bar{Y},\bar{y})\wedge\bigwedge_{i = 1}^{\length(\bar{X})} \forall\bar{z} X_i(\bar{z}) \wedge \forall\bar{z}(\bar{z}\leq\bar{x})\wedge\bigwedge_{i = 1}^{\length(\bar{Y})} \forall\bar{z} Y_i(\bar{z}) \wedge \forall\bar{z}(\bar{z}\leq\bar{y})\wedge\forall\bar{u}'(\bar{u}\leq\bar{u}'))].
\end{align*}
Finally, consider a $\eqso(\LL)$ formula $\alpha$ in $\LL$-SNF. If $\alpha = \sum_{i = 1}^n\alpha_i$, then by induction we can consider $\alpha = \alpha_1 + (\sum_{i = 2}^n\alpha_i)$ and use $\tau(\alpha_1 + \tau(\sum_{i = 2}^n\alpha_i))$ as the rewrite of $\alpha$, which satisfies the condition in the hypothesis.










\subsection*{Proof of Theorem \ref{prop-rest}}
We give this proof in three parts.

\vspace{1em}
First, we show that $\QE{0} \not\subseteq \E{1}$. By contradiction, suppose that there is a $\QE{0}$ formula $\alpha$ over some signature $\R$ such that defines the following function. For every finite $\R$-structure with $n$ elements, and where every predicate in $\R$ is empty, $\alpha(\enc(\A)) = n - 1$. We use the following claim.
\begin{claim}
Let $\alpha = \sa{\bar{x}}\varphi(\bar{x})$	where $\varphi$ is quantifier free. Then the function defined by $\alpha$ is either null, greater or equal to $n$, or is in $\Omega(n^2)$.
\end{claim}
\begin{proof}
Suppose that the function defined by $\alpha$ is not $0$ and that $\varphi$ is in DNF. Furthermore, suppose $\bar{x} = (x_1,\ldots,x_{\length(\bar{x})})$. Then $\alpha = \sa{\bar{x}} \varphi_1(\bar{x}) \vee \cdots \vee \varphi_n(\bar{x})$. Since $\alpha$ is not null, then some $\varphi_i$ must be satisfiable. This is, the function defined by $\sa{\bar{x}}\varphi(\bar{x})$ is not null. We will prove by induction on $\length(\bar{x})$ that the function defined by $\sa{\bar{x}}\varphi(\bar{x})$ is either greater or equal to $n$, or in $\Omega(n^2)$. We address the case $\length(\bar{x})= 1$, then $\alpha = \sa{x}\bigwedge\psi(x)$. If any $\psi(x) = (x = x)$ or $\neg(x < x)$, then we can eliminate it and we obtain the same function. If any $\psi = (x < x)$ or $\neg(x=x)$, then the function becomes null. If $\psi(x) = R(x,\ldots,x)$ for some $R\in\R$ the function becomes null for the structures we are considering. If $\psi(x) = \neg R(x,\ldots,x)$, we can eliminate it and for the structures we are considering we obtain the same function. The only possible $\alpha$ left is $\alpha = \sa{x}\top$ which is equal to the function $n$. This covers all possible cases for $\length(\bar{x}) = 1$. Now suppose that it holds for $\length(\bar{x}) = k$ and suppose $\alpha = \sa{\bar{x}}\bigwedge\psi(\bar{x})$ for $\length(\bar{x}) = k+1$. If any $\psi(\bar{x}) = (x_i = x_j)$ where $i \neq j$, then $\alpha$ describes the same function as $\alpha$ where $x_j$ has been replaced by $x_i$. In this formula the tuple of first-order variables has $k$ elements so the function it describes if one of the mentioned in the hypothesis. If $i = j$, then we can eliminate it and obtain the same function. If any $\psi(\bar{x}) = R(\bar{v})$ or $\neg R(\bar{v})$ where $\bar{v}$ is a sub-tuple of $\bar{x}$ then we can either eliminate it or the function becomes null, following the same argument as in the case $\length(\bar{x}) = 1$. If any $\psi(\bar{x}) = \neg(x_i = x_j)$ or $(x_i < x_j)$ where $i = j$, then the function becomes null. If any $\psi(\bar{x}) = \neg(x_i < x_j)$ where $i = j$, we can eliminate it. The remaining formulas in $\bigwedge\psi(\bar{x})$ are either $\neg(x_i = x_j)$, $(x_i<x_j)$ or $\neg(x_i<x_j)$. If the formula violates transitivity in $<$ (for example, $x < y \wedge y < z \wedge z < x$), then the function $\alpha$ describes is null. Therefore, there is some order over $\bar{x}$ that satisfies $\bigwedge\psi(\bar{x})$. Consider the formula that describes this order (like $x_1 < x_3 \wedge x_3 < x_4 \wedge x_4 < x_2$). The function $\alpha$ describes is greater or equal to the one this formula describes, which is exactly $\binom{n}{\length(\bar{x})}$ which is in $\Omega(n^{\length(\bar{x})}) \subseteq \Omega(n^2)$ if $\length(\bar{x}) > 1$. This concludes the proof of the claim.
\end{proof}
We suppose that $\alpha$ is in SNF, this is, $\alpha = \sum_{i = 1}^n\alpha_i$. Since $\alpha$ is not null, consider some $\alpha_i$ that describes a non-null function. Let $\alpha_i = \sa{\bar{X}}\sa{\bar{x}}\varphi(\bar{X},\bar{x})$, where $\varphi$ is quantifier-free. Note that if $\length(\bar{X}) > 0$, then the function $\alpha$ describes is in $\Omega(2^n)$, as it was proven by the authors in \cite{SalujaST95}. We have that $\alpha_i = \sa{\bar{x}}\varphi(\bar{x})$, as we proved in the claim, describes either some function greater or equal to $n$, or in $\Omega(n^2)$, which leads to a contradiction. Lastly, note that the formula $\sa{x}\exists y(x < y)$ is in $\E{0}$ and describes the function $n-1$, which concludes the proof.

\vspace{1em}
Now we show that $\E{1}\not\subseteq\QE{0}$. In Theorem \ref{theo-pi1-pnf} we proved that there is no formula in $\loge{1}$-PNF equivalent to the formula $\alpha = 2$. Every formula in $\E{1}$ can be expressed in $\loge{1}$-PNF, which implies that $2 \in \QE{0}$ and $2 \not\in \E{1}$.

\vspace{1em}
Lastly, we prove that $\eqso(\loge{1})\subsetneq\eqso(\logu{1})$. For inclusion, let $\alpha$ be a formula in $\eqso(\loge{1})$. Suppose that it is in $\loge{1}$-SNF. This is, $\alpha = c + \sum_{i = 1}^{n}\alpha_i$. Let $\alpha_i = \sa{\bar{X}}\sa{\bar{x}}\exists\bar{y}\,\varphi_i(\bar{X},\bar{x},\bar{y})$, where $\varphi_i$ is quantifier-free, for each $\alpha_i$. We use the same construction used in \cite{SalujaST95}, and we obtain that the formula $\exists\bar{y}\,\varphi_i(\bar{X},\bar{x},\bar{y})$ is equivalent to $\sa{\bar{y}}\,\varphi_i(\bar{X},\bar{x},\bar{y}) \wedge \forall\bar{y}'(\varphi_i(\bar{X},\bar{x},\bar{y}')\to\bar{y}\leq\bar{y}')$ for every assignment to $(\bar{X},\bar{x})$. We do this replacement for each $\alpha_i$ and we obtain an equivalent formula in $\eqso(\logu{1})$.

To prove that the inclusion is proper, consider the $\eqso(\logu{1})$ formula $\sa{x}\forall y(y = x)$. This formula defines the following function that takes an ordered structure $\A$ as input:
$$
\sem{\alpha}(\A) = 
\begin{cases}
1 &\A \text{ has one element}\\
0 &\text{ otherwise}.
\end{cases}
$$
Suppose that there exists an equivalent formula $\alpha$ in $\eqso(\loge{1})$. Also, suppose that it is in $\L$-PNF, so $\alpha = c + \sum_{i = 1}^n\sa{\bar{X}}\sa{\bar{x}}\exists\bar{y}\varphi_i(\bar{X},\bar{x},\bar{y})$. Since $\alpha$ takes the value 0 for some structures, $c$ must be 0. Consider a structure with one element $\mathfrak{1}$. We have that for some $i$, there exists an assignment $(\bar{B},\bar{b},\bar{a})$ for $(\bar{X},\bar{x},\bar{y})$ such that $\mathfrak{1}\models\varphi_i(\bar{B},\bar{b},\bar{a})$. Consider now the structure $\mathfrak{2}$ that is obtained by duplicating $\mathfrak{1}$, as we did for Theorem \ref{theo-pi1-pnf}. Note that $\mathfrak{2}\models\varphi_i(\bar{B},\bar{b},\bar{a})$, which implies that $\sem{\alpha}(\mathfrak{2}) \geq 1$, which leads to a contradiction.










\subsection*{Proof of Proposition \ref{prop-e1-nc}}

Towards a contradiction, assume that the statement is false. This is, that $\E{1}$ is closed under binary sum. Consider the formula $\sa{x}(x = x)$ which is in $\E{1}$ over some signature $\R$. For every finite $\R$-structure $\A$ with $n$ elements, and where every predicate in $\R$ is empty, $\alpha(\enc(\A)) = n$. From our assumption, there exists some formula in $\E{1}$ equivalent to the formula $\alpha \add \alpha$, which describes the function $2n$. Let $\sa{\bar{X}}\sa{\bar{x}}\exists\bar{y}\,\varphi(\bar{X},\bar{x},\bar{y})$ be this formula, where $\varphi$ is quantifier-free. Note that the function defined by this formula is equal or greater than the one defined by $\sa{\bar{X}}\sa{\bar{x}}\sa{\bar{y}}\,\varphi(\bar{X},\bar{x},\bar{y})$ divided by a polynomial factor. More specifically, for each ordered structure $\A$ with domain $A$, we have the following inequality:
$$
\sem{\sa{\bar{X}}\sa{\bar{x}}\exists\bar{y}\,\varphi(\bar{X},\bar{x},\bar{y})}(\A) \cdot \vert A \vert^{\length(\bar{y})} \geq \sem{\sa{\bar{X}}\sa{\bar{x}}\sa{\bar{y}}\,\varphi(\bar{X},\bar{x},\bar{y})}(\A)
$$
Note that the formula $\sa{\bar{X}}\sa{\bar{x}}\sa{\bar{y}}\,\varphi(\bar{X},\bar{x},\bar{y})$ defines a function in $\E{0}$. It was shown by the authors in \cite{SalujaST95} that every function in $\E{0}$ grows exponentially over the size of the structure for large enough structures, when $\length(\bar{X}) > 0$. This function divided by a polynomial factor still grows exponentially. Therefore, for $\sa{\bar{X}}\sa{\bar{x}}\exists\bar{y}\,\varphi(\bar{X},\bar{x},\bar{y})$ we have that $\length(\bar{X}) = 0$.

Now, for the formula $\sa{\bar{x}}\exists\bar{y}\,\varphi(\bar{x},\bar{y})$ consider a structure $\mathfrak{1}$ with only one element $a$. We have that $\sem{\sa{\bar{x}}\exists\bar{y}\,\varphi(\bar{x},\bar{y})}(\mathfrak{1}) = 2$, but the only possible assignment to $\bar{x}$ is the tuple $(a,\ldots,a)$ so $\sem{\sa{\bar{x}}\exists\bar{y}\,\varphi(\bar{x},\bar{y})}(\mathfrak{1}) \leq 1$, which follows to a contradiction.










\subsection*{Proof of Proposition \ref{prop:qe0-fp-qe1-totp-fptras}}

We separate this proof in three parts

\vspace{1em}
The authors in \cite{SalujaST95} proved that there exists a {\em product reduction} from every function in $\E{1}$ to a restricted version of $\cdnf$. This is, if $\alpha\in\E{1}$ over some signature $\R$, there exist polynomially computable functions $g:\ostr[\R]\to\ostr[\R_{\text{DNF}}]$ and $h:\nat\to\nat$ such that for every finite $\R$-structure $\A$ with domain $A$, it holds that $\sem{\alpha}(\A) = \cdnf(\enc(g(\A)))\cdot h(\vert A \vert)$. We base our proof on this fact.

For the first part, let $\alpha$ be a $\eqso(\loge{1})$ formula and assume that it is in $\loge{1}$-SNF. This is, $\alpha = \sum_{i = 1}^n\alpha_i$ where each $\alpha_i$ is in $\loge{1}$-PNF. Consider the following nondeterministic procedure that on input $\enc(\A)$ generates $\sem{\alpha}(\A)$ branches. For each $\alpha_i = \varphi$, where $\varphi$ is a $\loge{1}$ formula, it checks if $\A\models\varphi$ in polynomial time and generates a new branch if that is the case. For each $\alpha_i = \sa{\bar{X}}\sa{\bar{x}}\varphi$, this formula is also in $\E{1}$. We use the reduction to $\cdnf$ provided in \cite{SalujaST95} and we obtain $g(\enc(\A))$, which is an instance to $\cdnf$. Since $\cdnf$ is also in $\totp$ \cite{PagourtzisZ06}, we simulate the corresponding nondeterministic procedure that generates exactly $\cdnf(\enc(g(\A)))$ branches. Since, $\fp\subseteq\totp$\cite{PagourtzisZ06}, each polynomially computable function is also in $\totp$, and then on each of these branches we simulate the corresponding nondeterministic procedure to generate $h(\vert A \vert)$ more. The number of branches for each $\alpha_i$ is $\sem{\alpha_i}(\A) = \cdnf(\enc(g(\A)))\cdot h(\vert A \vert)$, and the total number of branches in the procedure amounts to $\sem{\alpha}(\A)$. We conclude that $\alpha\in\totp$.

\vspace{1em}
For the second part, let $\alpha$ be a $\eqso(\loge{1})$ formula and assume that it is in $\loge{1}$-SNF. This is, $\alpha = \sum_{i = 1}^n\alpha_i$ where each $\alpha_i$ is in $\loge{1}$-PNF. Note that each $\alpha_i$ that is equal to some $\loge{1}$ formula $\varphi$ has an FPRAS given by the procedure that simply checks if $\A\models\varphi$ and returns 1 if it does and 0 otherwise. Also, each remaining $\alpha_i$ has an FPRAS since $\alpha_i\in \E{1}$ \cite{SalujaST95}. If two functions have an FPRAS, then their sum also has one given by the procedure that simulates them both and sums the results. We conclude that $\alpha$ has an FPRAS.

\vspace{2em}
For the third part, we will prove that $\eqso(\loge{1})$ is closed under sum and multiplication. Since $\eqso(\loge{1})$ is closed under sum by definition, we focus only in proving that the class is closed under multiplication. We prove this for a more general case for $\eqso(\LL)$ where $\LL$ is a fragment of $\so$.

\begin{lemma} \label{conj-mult}
If $\LL$ is a fragment closed under conjunction, then $\eqso(\LL)$ is closed under binary multiplication.
\end{lemma}
\begin{proof}
We will define a recursive function $\tau$ that receives a formula $\alpha$ over the grammar of $\eqso(\LL)$ extended by binary product, and outputs an equivalent formula $\tau(\alpha)$ over the unextended grammar of $\eqso(\LL)$. In fact, the formula $\tau(\alpha)$ is in $\LL$-SNF. First we replace each constant $s$ in $\alpha$ for $(\top \add \cdots \add \top)$ ($s$ times). If $\alpha = \varphi$, then we define $\tau(\alpha) = \alpha$. We assume that for every $\beta$ that has less algebraic operators than $\alpha$, $\tau(\beta)$ is in $\LL$-SNF. If $\alpha = (\alpha_1 + \alpha_2)$ then we define $\tau(\alpha) = \tau(\alpha_1) + \tau(\alpha_2)$. If $\alpha = \sa{x}\beta$ or $\alpha = \sa{X}\beta$, then we define $\tau(\alpha)$ as the formula in $\LL$-SNF that is equivalent to $\sa{x}\tau(\beta)$ and to $\tau(\alpha) = \sa{X}\tau(\beta)$, respectively. If $\alpha = (\alpha_1 \cdot \alpha_2)$, we assume that each $\alpha_i$ is in $\LL$-SNF. We identify three cases. (1) Some $\alpha_i$ is equal to $\sum_{j = 1}^n\beta_j$ for $n > 1$. Suppose wlog. that it is $\alpha_1$. We then define $\tau(\alpha) = \sum_{j = 1}^n\tau(\beta_j\cdot\alpha_2)$. In the following cases, $\alpha_1$ and $\alpha_2$ are in $\LL$-SNF. (2) If some $\alpha_i$ is equal to $\sa{X}\beta$ or $\sa{x}\beta$, we define $\tau(\alpha)$ as the $\LL$-SNF formula that is equivalent to $\sa{x}\tau(\beta\cdot\alpha_2)$ and $\sa{X}\tau(\beta\cdot\alpha_2)$, respectively. The remaining case is (3) $\alpha_1 = \varphi_1$ and $\alpha_2 = \varphi_2$ where each $\varphi$ is an $\LL$ formula. Then we define $\tau(\alpha) = \varphi_1 \wedge \varphi_2$. This covers all possible cases for $\alpha$. For every pair of formulas $\alpha,\beta$ in $\eqso(\LL)$, we have that their multiplication $(\alpha\cdot\beta)$ is a formula in the grammar $\eqso(\LL)$ extended by binary product, and so, there exists an equivalent formula $\tau(\alpha\cdot\beta)$ which is in unextended $\eqso(\LL)$.
\end{proof}
Since $\loge{1}$ is closed under conjunction, this also holds for $\eqso(\loge{1})$. This concludes the proof.










\subsection*{Proof of Proposition \ref{pi-minusone}}

Let $\LL$ be a fragment of $\fo$ that contains $\logu{1}$. Then we have that every function in $\U{1}$ is expressible in $\eqso(\LL)$. In particular, $\ctcnf \in \eqso(\LL)$. Suppose that $\eqso(\LL)$ is closed under subtraction by one. Then, the function $\ctcnf-1$, which counts the number of satisfying assignments of a 3-CNF formula minus one, is also in $\eqso(\LL)$. Note that $\eqso(\LL) \subseteq \eqso(\fo) = \shp$. We have that $\ctcnf$ is $\shp$-complete under parsimonious reductions\footnote{It can be easily verified that the standard reduction from SAT to 3-CNF (or 3-SAT) preserves the number of satisfying assignments}. Now, let $f$ be a function in $\shp$, and consider the nondeterministic polynomial-time procedure that on input $\enc(\A)$ computes the corresponding reduction to $\ctcnf$, name it $g(\enc(\A))$, and simulates the $\shp$ procedure for $\ctcnf-1$ on input $g(\enc(\A))$. We have that this is a $\shp$ procedure that computes $f-1$, from which we conclude that $\shp$ is closed under subtraction by one.










\subsection*{Proof of Theorem \ref{sigmafo-minusone}}

{\bf Part 1.} We show here that $\eqso(\logex{1})$ is closed under sum and multiplication. This can be seen because $\eqso(\LL)$ is closed under sum for every fragment $\LL$ by definition, and since $\logex{1}$ is closed under conjunction, from Lemma \ref{conj-mult} it follows that $\eqso(\logex{1})$ is closed under multiplication.

\vspace{1em}
{\bf Part 2.} We show here that $\eqso(\logex{1}) \subseteq \totp$ and every function in $\eqso(\logex{1})$ has an FPRAS. We do this by showing a parsimonious reduction from a function in $\eqso(\logex{1})$ to some function in $\eqso(\loge{1})$, and using the result of Theorem \ref{prop:qe0-fp-qe1-totp-fptras}. First, we define a function that converts a formula $\alpha$ in $\eqso(\logex{1})$ over a signature $\R$ into a formula $\lambda(\alpha)$ in $\eqso(\loge{1})$ over a signature $\R_{\alpha}$. Afterwards, we define a function $g_{\alpha}$ that receives an $\R$-structure $\A$ and outputs an $\R_{\alpha}$-structure $g_{\alpha}(\A)$.

Let $\alpha$ be in $\eqso(\logex{0})$. The signature $\R_{\alpha}$ is obtained by adding the symbol $R_{\psi}$, for every $\fo$ formula $\psi(\bar{z})$ in $\alpha$, to $\R$. Each symbol $R_{\psi}$ represents a predicate with arity $\length(\bar{z})$. Then, $\lambda(\alpha)$ is defined as $\alpha$ where each $\fo$ formula $\psi(\bar{z})$ has been replaced by $R_{\psi}(\bar{z})$. We now define the function $g_{\alpha}$ procedurally. Let $\A$ be a $\R$-structure with domain $A$. Let $\A'$ be an $\R_{\alpha}$-structure obtained by copying $\A$ and leaving each $R_{\psi}^{\A}$ empty. For each $\fo$-formula $\psi(\z)$ with $\length(\bar{z})$ open first-order variables, we iterate for every tuple $\bar{a} \in A^{\length(\bar{z})}$. If $\A\models\psi(\bar{a})$, then the tuple $\bar{a}$ is added to $R_{\psi}^{\A'}$. This concludes the construction of $\A'$. Note that the number of $\fo$ subformulas and each arity and tuple size is fixed to $\alpha$, so computing this function takes polynomial time over the size of the structure. Moreover, the encoding of $\A'$ has polynomial size over the size of $\enc(\A)$. We define $g_{\alpha}(\A) = \A'$ and we have that for each $\R$-structure $\A$: $\sem{\alpha}(\A) = \sem{\lambda(\alpha)}(g_{\alpha}(\A))$. Therefore, we have a parsimonious reduction from $\alpha$ to the $\eqso(\loge{1})$ formula $\lambda(\alpha)$.

To show that $\alpha$ is in $\totp$, consider a procedure that takes an input $\enc(\A)$, converts it to $\enc(g_{\alpha}(\A))$ and simulates the $\totp$ procedure for $\lambda(\alpha)$ on input $\enc(g_{\alpha}(\A))$. This procedure generates exactly $\sem{\alpha}(\A) = \sem{\lambda(\alpha)}(g_{\alpha}(\A))$ branches, and therefore $\alpha$ is in $\totp$.

To show that $\alpha$ has an FPRAS, consider a procedure that takes an input $\enc(\A)$, converts it to $\enc(g_{\alpha}(\A))$ and simulates the FPRAS for $\lambda(\alpha)$. This procedure also takes polynomial time and satisfies the condition.

\vspace{1em}
{\bf Part 3.} We prove here that $\eqso(\logex{1})$ is closed under subtraction by one. Let $\alpha$ be a $\eqso(\logex{1})$ formula over a signature $\R$. We will define a $\eqso(\logex{1})$ formula $\kappa(\alpha)$ such that for each finite structure $A$ over $\R$: $\sem{\kappa(\alpha)}(\A) = \sem{\alpha}(\A) \dotminus 1$. We suppose that $\alpha$ is in $\logex{1}$-SNF and $\alpha = \sum_{i = 1}^{n}\sa{\bar{X}}\sa{\bar{x}}\varphi_i$ where each $\varphi_i$ is in $\logex{1}$. Moreover, we assume that $\length(\bar{x}) > 0$ and $\length(\bar{X}) > 0$ since we can replace each $\varphi_i$ for the equivalent formula $\sa{Y}\sa{y}\varphi_i\wedge\first(y)\wedge\forall z Y(z)$.

The proof will be separated in two parts. (i) If $\alpha$ is in $\logex{1}$-PNF, this is, $\alpha = \sa{\bar{X}}\sa{\bar{x}}\varphi$ for some $\varphi$ in $\logex{1}$, then we define a formula $\varphi'$ that satisfies the following condition. For each $\A$, if $(\A,V,v)\models \varphi(\bar{X},\bar{x})$ for some $V$ and $v$ over $\A$, then there exists exactly one assignment to $(\bar{X},\bar{x})$ that satisfies $\varphi$ and not $\varphi'$. We define $\kappa(\alpha) = \sa{\bar{X}}\sa{\bar{x}}\varphi'$. (ii) If $\alpha = \beta + \sa{\bar{X}}\sa{\bar{x}}\varphi$, then we define a formula $\varphi'$ that satisfies the following condition. For each $\A$, if $(\A,V,v)\models \varphi(\bar{X},\bar{x})$ for some $V$ and $v$ over $\A$ {\bf and} $\sem{\beta}(\A) = 0$, then there exists exactly one assignment to $(\bar{X},\bar{x})$ that satisfies $\varphi$ and not $\varphi'$. We define $\kappa(\alpha) = \kappa(\beta) +  \sa{\bar{X}}\sa{\bar{x}}\varphi'$.

\vspace{1em}

{\em Section (i).}  Let $\alpha =  \sa{\bar{X}}\sa{\bar{x}}\exists\bar{y}\, \varphi(\bar{X},\bar{x},\bar{y})$ where $\varphi$ is quantifier-free with the addition of atomic formulas in $\fo$. We call this syntax {\em extended quantifier-free} from now on. Let $\bar{x} = (x_1,\ldots,x_{\length(\bar{x})})$ and $\bar{X} = (X_1,\ldots,X_{\length(\bar{X})})$.
We convert $\varphi$ into an equivalent formula of the form $\bigvee_{i = 1}^m\varphi_i$ where each $\varphi_i$ is of the form:
$$
\varphi_i(\bar{X},\bar{x},\bar{y}) = \underbrace{\varphi_i^{\fo}(\bar{x},\bar{y})}_{\text{an $\fo$ formula}} \wedge
\underbrace{\varphi_i^{-}(\bar{X},\bar{x},\bar{y})}_{\text{conjunction of $\neg X_j$'s}} \wedge \underbrace{\varphi_i^{+}(\bar{X},\bar{x},\bar{y})}_{\text{conjunction of $X_j$'s}}.
$$
This can be done with a standard predicate-DNF transformation algorithm. We now define a series of transformations to $\varphi$ that will make each formula $\varphi$ satisfy the following three conditions. (a) Each first-order variable in $\varphi_i^{-}(\bar{X},\bar{x},\bar{y})\wedge\varphi_i^{+}(\bar{X},\bar{x},\bar{y})$ is mentioned at most once. Moreover, in this formula no variable in $\bar{x}$ is mentioned. (b) $\varphi_i^{\fo}(\bar{x},\bar{y})$ defines an ordered partition over the variables in $(\bar{x},\bar{y})$. We will define then what we mean by an ordered partition. (c) If $X_j(\bar{z})$ and $\neg X_j(\bar{w})$ are mentioned, then the ordered partition should not satisfy $\bar{z} = \bar{w}$.
\begin{itemize}
	\item[(a)] Consider some instance of a $X_j(\bar{w})$ in $\varphi_i$, where $\bar{w}$ is a subtuple of $(\bar{x},\bar{y})$. We add $\length(\bar{w})$ new variables $z_1,\ldots,z_{\length(\bar{w})}$ to the formula and let $\bar{z} = (z_1,\ldots,z_{\length(\bar{w})})$. We redefine $\varphi_i^{+}(\bar{X},\bar{x},\bar{y})$ by replacing $X_j(\bar{w})$ with $X_j(\bar{z})$. The formula $\varphi_i$ is now defined as
	$$
	\varphi_i(\bar{X},\bar{x},(\bar{y},\bar{z})) = (\bar{z} = \bar{w} \wedge \varphi_i^{\fo}(\bar{x},\bar{y})) \wedge \varphi_i^{-}(\bar{X},\bar{x},\bar{y}) \wedge \varphi_i^{+}(\bar{X},\bar{x},\bar{y}).
	$$
	We repeat this process for each instance of a $X_j(\bar{w})$ in $\varphi_i$, and we obtain a formula where none of the $X_j$'s acts over any variable in $\bar{x}$. We add the new first-order variables to $\bar{y}$ and we redefine $\varphi_i$ as
	$$
	\varphi_i(\bar{X},\bar{x},\bar{y}) = \varphi_i^{\fo}(\bar{x},\bar{y}) \wedge \varphi_i^{-}(\bar{X},\bar{y}) \wedge \varphi_i^{+}(\bar{X},\bar{y}).
	$$
	For example, if $\bar{x} = x$, $\bar{y} = y$ and $\varphi_i = X(x,y)\wedge \neg X(x,x) \wedge x < y$, then we redefine $\bar{y} = (y,v_1,v_2,v_3,v_4)$ and $\varphi_i := X(v_1,v_2) \wedge \neg X(v_3,v_4) \wedge x < y \wedge v_1 = x \wedge v_2 = y \wedge v_3 = x \wedge v_4 = x.$ 
	\item[(b)] An ordered partition on a set $S$ is defined by an equivalence relation $\sim$ over $S$, and a linear order over $S/\!\sim$. For example, let $\bar{x} = (x_1,x_2,x_3,x_4)$. A possible ordered partition would be defined by the formula $\theta(\bar{x}) = x_2 < x_1 \wedge x_1 = x_4 \wedge x_4 < x_3$. On the other hand, the formula $\theta'(\bar{x}) = x_1 < x_2 \wedge x_1 < x_4 \wedge x_2 = x_3$ does not define an ordered partition since both $\{x_1\}<\{x_2,x_3\}<\{x_4\}$ and $\{x_1\} < \{x_2,x_3,x_4\}$ satisfy $\theta'$.
	For a given $k$, let $\cB_k$ be the number of possible ordered partitions for a set of size $k$. For $1 \leq j \leq \cB_{\length(\bar{x},\bar{y})}$ 
	let $\theta^j(\bar{x},\bar{y})$ be a formula that defines an ordered partition over $(\bar{x},\bar{y})$. 
	
	The formula $\varphi(\bar{X},\bar{x},\bar{y})$ is then redefined as
	$$
	\bigvee_{i = 1}^m \bigvee_{j = 1}^{\cB_{\length(\bar{x},\bar{y})}}[\theta^j(\bar{x},\bar{y})\wedge \varphi_i(\bar{X},\bar{x},\bar{y})],
	$$
	and each of these disjuncts is a $\varphi_i$. Therefore, each $\varphi_i^{\fo}(\bar{x},\bar{y})$ defines an ordered partition over the variables in $(\bar{x},\bar{y})$.
	\item[(c)] For each $\varphi_i$, we do the following. If there exists an instance of $X_j(\bar{z})$ in $\varphi^{+}_i$, an instance of $\neg X_j(\bar{w})$ in $\varphi^{-}_i$ and the ordered partition in $\varphi^{\fo}_i$ satisfies $\bar{z} = \bar{w}$, then the entire formula $\varphi_i$ is removed from $\varphi$.
\end{itemize}
It is important to notice that the resulting $\varphi$ is equivalent to the initial one, and it is still an extended quantifier-free formula. From now on, we assume that each $\varphi_i(\bar{X},\bar{x},\bar{y}) = \varphi^{\fo}_i(\bar{x},\bar{y}) \wedge \varphi^{-}_i(\bar{X},\bar{x},\bar{y}) \wedge \varphi^{+}_i(\bar{X},\bar{x},\bar{y})$ satisfies conditions (a), (b) and (c). Note the following.
\begin{claim}
For a given ordered structure $\A$, if there exists a first-order assignment $v$ for $\A$ such that $(\A,v)\models\varphi^{\fo}_i(\bar{x},\bar{y})$, then there exists a second-order assignment $V$ for $\A$ such that  $(\A,V,v)\models\varphi_i(\bar{X},\bar{x},\bar{y})$.
\end{claim}
\begin{proof}
Let $\A$ be an ordered structure with domain $A$ and let $v$ be a first-order assignment for $\A$ such that $(\A,v)\models\varphi^{\fo}_i(\bar{x},\bar{y})$.
Define $\bar{B} = (B_1,\ldots,B_{\length(\bar{X})})$ as $B_j = \{v(\bar{w})\mid\bar{w}\text{ is a subtuple of $\bar{y}$ and $X_j(\bar{w})$ is mentioned in $\varphi^{+}_i(\bar{X},\bar{y})$}\}$, and let $V$ be a second-order assignment for which $V(\bar{X}) = \bar{B}$.
Towards a contradiction, suppose that $(\A,V,v)\not\models\varphi_i(\bar{X},\bar{x},\bar{y})$.
By the choice of $v$, and construction of $V$ it is clear that $(\A,V,v)\models\varphi^{\fo}_i(\bar{x},\bar{y})\wedge\varphi^{+}_i(\bar{X},\bar{x},\bar{y})$, so we necessarily have that $(\A,V,v)\not\models\varphi^{-}_i(\bar{X},\bar{x},\bar{y})$.
Let $X_t$ be such that $\neg X_t(\bar{w})$ is mentioned in $\varphi^{-}_i(\bar{X},\bar{y})$ and $(\A,v)\not\models\neg B_t(\bar{w})$.
This is, $v(\bar{w})\in B_t$, but because of the way we constructed $B_t$, there exists a subtuple $\bar{z}$ of $\bar{y}$ such that $X_t(\bar{z})$ appears in $\varphi^{+}_i(\bar{X},\bar{y})$ and $v(\bar{z}) = v(\bar{w})$. Since $(\A,v)\models\varphi^{\fo}_i(\bar{x},\bar{y})$ and $v(\bar{z}) = v(\bar{w})$, then the ordered partition in $\varphi^{\fo}_i$ satisfies $\bar{z} = \bar{w}$. However, this violates condition (c) since $\neg X_t(\bar{w})$ appears in $\varphi^{-}_i$ and $X_t(\bar{z})$ appears in $\varphi^{+}_i$, which leads to a contradiction. \end{proof}
We generalize the construction of $\bar{B}$ given in the claim. For a structure $\A$ and a first-order assignment $v$ for $\A$, then we define $\bar{B}^v = (B^v_1,\ldots,B^v_{\length(\bar{X})})$ where each $B^v_j = \{v(\bar{w})\mid\bar{w}\text{ is a subtuple of $\bar{y}$ and $X_j(\bar{w})$ is mentioned in $\varphi^{+}_i(\bar{X},\bar{y})$}\}$. Now, let $\bar{v}$ be the subtuple of $\bar{y}$ of every first-order variable mentioned in $\varphi_i^{+}$ and let $\bar{u}$ be a subtuple of $(\bar{x},\bar{y})$ such that concatenating $(\bar{v},\bar{u})$ is equal to $(\bar{x},\bar{y})$. We also define $v^*$ as a first-order assignment for $\A$ for which we have that $v^{*}(\bar{v})$ is the lexicographically smallest tuple that satisfies $(\A,v^{*})\models\exists\bar{u} \varphi^{\fo}_i(\bar{u},\bar{v})$. Lastly, we define $\bar{B}^* = \bar{B}^{v^{*}}$ and $V^*$ as some second-order assignment for $\A$ for which $V^*(\bar{X}) = \bar{B}^*$.

We define a formula $\mu_i$ that is satisfied only by $v^*$:
$$
\mu_i(\bar{v}) = \exists\bar{u}\,\varphi_i^{\fo}(\bar{u},\bar{v})\wedge\forall\bar{u}'\forall\bar{v}'(\varphi_i^{\fo}(\bar{u}',\bar{v}')\to\bar{v}\leq\bar{v}').
$$ 
The following is a pivotal formula in our proof:
\begin{align}
\psi_i(\bar{X},\bar{x}) = &\exists\bar{v}\bigg(\overbrace{\mu_i(\bar{v})}^{(\blacktriangleleft)}\wedge\Big( \overbrace{\neg\varphi^{+}_i(\bar{X},\bar{v})}^{(\blacktriangle)} \vee \overbrace{\bigvee_{X \in \bar{X}} \exists\bar{z}(X(\bar{z}) \wedge \bigwedge\limits_{\substack{\text{subtuples }\bar{w} \text{ of }\bar{v} \text{ s.t.}\\ X(\bar{w})\text{ is mentioned} \\ \text{in }\varphi^{+}_i(\bar{X},\bar{v})}}\bar{w}\neq\bar{z}}^{(\blacktriangledown)})\Big)\bigg) \vee \label{minusone-1}\\ &\exists\bar{x}'(\exists\bar{y}'\varphi_i(\bar{X},\bar{x}',\bar{y}')\wedge \bar{x}'<\bar{x})\vee \label{minusone-2} \\ 
&\neg\exists\bar{x}\exists\bar{y}\varphi^{\fo}_i(\bar{x},\bar{y}). \label{minusone-3}
\end{align}
Consider some $\A$. In detail, the formula \eqref{minusone-1} represents the following: In $(\blacktriangleleft)$, we make it so the only value for $\bar{v}$ we consider is $v^{*}(\bar{v})$. In $(\blacktriangle)$, we mention that the assignment for $\bar{X}$ satisfies the formula if does not contain at least one of the tuples in $v^{*}(\bar{v})$. In $(\blacktriangledown)$, we mention that in the assignment for $\bar{X}$ also satisfies the formula if it contains at least one tuple, in one of the $X$'s, that is not equal to the one in $v^{*}(\bar{v})$. Then, in the formula \eqref{minusone-2} we mention that the assignment for $\bar{x}$ satisfies the formula if it is not the lexicographically smallest assignment that satisfies $\varphi_i$ for that particular assignment for $\bar{X}$. Lastly, in \eqref{minusone-3}, we mention that the assignment for $(\bar{X},\bar{x})$ satisfies the formula if there are no assignments $V,v$ for $\A$ such that $(\A,V,v)\not\models \exists\bar{y}\varphi_i(\bar{X},\bar{x},\bar{y})$.

This way, the formula $\psi(\bar{X},\bar{x})$ functions as a sort of filter for valid assignments for $\bar{X}$ and $\bar{x}$. For each structure $\A$ we have that the only $V,v$ for which $(\A,V,v)\models\exists\bar{y}\varphi_i(\bar{X},\bar{x},\bar{y})$ and also $(\A,V,v)\not\models\psi_i(\bar{X},\bar{x})$ is the one given by $v = v^*$ and $V = V^*$, should there exist one.
%We prove this formally.
%\begin{lemma}
%	For a given ordered structure $\A$ such that $\A\models\exists\bar{X}\exists\bar{x}\exists\bar{y}\,\varphi_i(\bar{X},\bar{x},\bar{y})$, there is an assignment $(\bar{B},\bar{b})$ to $(\bar{X},\bar{x})$ that satisfies the following conditions (1) $\A\models\exists\bar{y}\,\varphi_i(\bar{B},\bar{b},\bar{y})$, (2) $\A\not\models\psi_i(\bar{B},\bar{b})$ and (3) this is the only assignment to $(\bar{X},\bar{x})$ that satisfies (1) and (2).
%\end{lemma}
%\begin{proof}
%	Excusing the nested proof, we have a claim that identifies a crucial condition that is verifiable with a $\fo$ formula. 
%	
%	We give the proof for the base theorem. Let $\A$ be an ordered structure with domain $A$. We clearly have that $\A\models\exists\bar{x}\exists\bar{y}\,\varphi^{\fo}_i(\bar{x},\bar{y})$, so let $\bar{a}\in A^{\length(\bar{y})}$ and $\bar{b}\in A^{\length(\bar{x})}$ such that $\A\models\mu_i(\bar{b},\bar{a})$. We use the same construction in the claim and we obtain the assignment $(\bar{B},\bar{b},\bar{a})$ which satisfies the three conditions.
%\end{proof}

We define $\chi_i = \neg\exists\bar{x}\exists\bar{y}\,\varphi^{\fo}_i(\bar{x},\bar{y})$. Now recall that $\varphi = \bigvee_{i = 1}^m\varphi_i(\bar{X},\bar{x},\bar{y})$. We define:
$$
\varphi'_1(\bar{X},\bar{x},\bar{y}) = \varphi_1(\bar{X},\bar{x},\bar{y})\wedge\psi_1(\bar{X},\bar{x}).
$$
This models that all the assignments that satisfy $\varphi_1$ also satisfy $\varphi'_1$, except for $(V^*,v^*)$. Then we define:
$$
\varphi'_2(\bar{X},\bar{x},\bar{y}) = \varphi_2(\bar{X},\bar{x},\bar{y})\wedge\psi_1(\bar{X},\bar{x})\wedge(\chi_1\to\psi_2(\bar{X},\bar{x})).
$$
This models that all the assignments that satisfy $\varphi_2$ also satisfy $\varphi'_2$, but if there was no assignment for $\varphi_1$, then we exclude $V^*,v^*$ for $\varphi_2$. Then we generalize this construction for each $\varphi_i$:
$$
\varphi_i'(\bar{X},\bar{x},\bar{y}) = \varphi_i(\bar{X},\bar{x},\bar{y})\wedge\psi_1(\bar{X},\bar{x})\wedge(\chi_1\to\psi_2(\bar{X},\bar{x}))\wedge((\chi_1\wedge\chi_2)\to\psi_2(\bar{X},\bar{x}))\wedge\cdots\wedge(
\bigwedge_{j = 1}^{j = i-1}\chi_j\to\psi_i(\bar{X},\bar{x})),
$$
and lastly, $\kappa(\alpha)$ is defined as $\kappa(\alpha) = \sa{\bar{X}}\sa{\bar{x}}\exists\bar{y}\bigvee_{i = 1}^m\varphi_i'(\bar{X},\bar{x},\bar{y})$, which satisfies our condition that $\sem{\kappa(\alpha)}(\A) = \sem{\alpha}(\A)-1$ for each $\A$.

\vspace{1em}

{\em Section (ii).} Let $\alpha = (\beta + \sa{\bar{X}}\sa{\bar{x}}\exists\bar{y}\,\varphi(\bar{X},\bar{x},\bar{y}))$ for some algebraic formula $\beta$ and some extended quantifier-free formula $\varphi$. We define $\kappa(\alpha)$ as follows: First, perform the same transformations to $\varphi(\bar{X},\bar{x},\bar{y})$ as in the previous section. Let $\varphi = \bigvee_{i = 1}^m\varphi_i(\bar{X},\bar{x},\bar{y})$ where each $\varphi_i$ satisfies conditions (a), (b) and (c). We also use the previously defined formulas $\chi_i$ and $\psi_i$, for each $i$. 

We construct a function $\lambda$ that receives a quantitative formula $\beta$ and produces a logic formula $\lambda(\beta)$ that satisfies $\A\models\lambda(\beta)$ if and only if $\sem{\beta}(\A) = 0$. If $\beta = \sa{\bar{x}}\exists\bar{y}\varphi(\bar{x},\bar{y})$, then $\lambda(\beta) = \neg\exists\bar{x}'\exists\bar{y}'\varphi(\bar{x}',\bar{y}')$. If $\beta = \sa{\bar{X}}\sa{\bar{x}}\exists\bar{y}\,\varphi(\bar{X},\bar{x},\bar{y})$, then let $\varphi = \bigvee_{i = 1}^{m}\varphi_i$ where each $\varphi_i$ satisfies conditions (a), (b) and (c) of the previous section, and $\lambda(\beta) = \chi_1\wedge \cdots\wedge\chi_m$ as each $\chi_i$ was previously defined. If $\beta = (\beta_1 + \beta_2)$, then $\lambda(\beta) = \lambda(\beta_1) \wedge \lambda(\beta_2)$.

Now, for each $\varphi_i$ we define:
$$
\varphi_i'(\bar{X},\bar{x},\bar{y}) = \varphi_i(\bar{X},\bar{x},\bar{y})\wedge\Big(\lambda(\beta)\to\Big(\psi_1(\bar{X},\bar{x})\wedge(\chi_1\to\psi_2(\bar{X},\bar{x}))\wedge((\chi_1\wedge\chi_2)\to\psi_2(\bar{X},\bar{x}))\wedge\cdots\wedge(
\bigwedge_{j = 1}^{j = i-1}\chi_j\to\psi_i(\bar{X},\bar{x}))\Big)\Big).
$$
And lastly $\kappa(\alpha)$ is defined as $\kappa(\alpha) = \kappa(\beta) + \sa{\bar{X}}\sa{\bar{x}}\exists\bar{y}\bigvee_{i = 1}^m\varphi_i'(\bar{X},\bar{x},\bar{y})$, which is in $\eqso(\logex{1})$ and satisfies the desired condition.









%\subsection*{Proof of Theorem \ref{sub-pnp}}
%
%Towards a contradiction, suppose that any of the classes $\E{1}$, $\eqso(\loge{1})$, and $\eqso(\logex{1})$ is closed under subtraction.
%
%Let $\R$ include the symbols $S_1, S_2, S_3, S_4$, which describe the following properties. If a finite $\R$-structure $\A$ defines a 3DNF formula $\Phi$, then its domain is the set of variables mentioned in $\Phi$, and for each $i = 1,2,3,4$:
%\begin{align*}
%	S_1^\A &= \{(a_1,a_2,a_3)\mid (\neg a_1 \wedge \neg a_2 \wedge \neg a_3) \mbox{ appears as a disjunct in }\Phi\},\\
%	S_2^\A &= \{(a_1,a_2,a_3)\mid ( a_1 \wedge \neg a_2 \wedge \neg a_3) \mbox{ appears as a disjunct in }\Phi\},\\
%	S_3^\A &= \{(a_1,a_2,a_3)\mid ( a_1 \wedge  a_2 \wedge \neg a_3) \mbox{ appears as a disjunct in }\Phi\},\\
%	S_4^\A &= \{(a_1,a_2,a_3)\mid ( a_1 \wedge  a_2 \wedge  a_3) \mbox{ appears as a disjunct in }\Phi\}.
%\end{align*}
%Now we define $f_{\#3DNF} = f_{\psi(T)}$ where
%\begin{multline*}
%\psi(T) = \exists x \exists y \exists z\, [(S_1(x,y,z) \wedge \neg T(x) \wedge \neg T(y) \wedge \neg T(z)) \vee (S_2(x,y,z) \wedge T(x) \wedge \neg T(y) \wedge \neg T(z)) \, \vee \\ (S_3(x,y,z) \wedge T(x) \wedge T(y) \wedge \neg T(z)) \vee (S_4(x,y,z) \wedge T(x) \wedge T(y) \wedge T(z))].
%\end{multline*}
%Note that $f_{\#3DNF} \in \#\Sigma_1$. Let $f_{all} = f_{\exists x\:\varphi(x,X)}$, where
%$$
%\varphi(x,X) = (T(x) \vee \neg T(x)).
%$$
%Note that $f_{all}$ counts every possible truth assignment (satisfying or not) to a 3DNF formula. Given that $f_{\#3DNF}, f_{all} \in \E{1} \subseteq \eqso(\loge{1}) \subseteq \eqso(\logex{1}) \subseteq \totp$, and at least one of the classes is closed under subtraction, the function $f_{\#3DNF} - f_{all}$ is in $\totp$. However, note that for each $\R$-structure $\A$ that represents a formula $\Phi$, $(f_{\#3DNF} - f_{all})(\A) = 0$ if an only if $\Phi$ is a tautology. The decision version of this function is the $\np$-complete problem $\textsc{Tautology}$. And since the function is in $\totp$, its decision version is also in $\ptime$. We conclude that $\np \subseteq \ptime$.










\subsection*{Proof of Proposition \ref{prop:ehorn-pe}}
Pagourtzis and Zachos mention a $\totp$ procedure that computes the number of satisfying assignments of a DNF formula \cite{PagourtzisZ06}. This procedure can be easily extended to receive Horn formulas, and furthermore, a disjunction of Horn formulas. We can deduce that $\shdhsat$ is in $\totp$.

As we show in Proposition \ref{sigma2hard}, $\shdhsat$ is complete for $\eqso(\ehorn)$ under parsimonious reductions. Let $\alpha$ be a formula in $\eqso(\ehorn)$ and let $g_{\alpha}$ be the reduction to $\shdhsat$. The $\totp$ procedure we construct, for each input $\enc(\A)$, is simply to compute $g_{\alpha}(\enc(\A))$, and then simulate the $\totp$ procedure for $\shdhsat$ on input $g_{\alpha}(\enc(\A))$. We conclude that $\alpha$ is in $\totp$.










\subsection*{Proof of Proposition \ref{prop:hsat-not-sigma2}} %V.12
We use a similar proof to the one provided by the authors in \cite{SalujaST95} to separate the classes $\E{2}$ and $\U{2}$. Suppose that the statement is false, this is, $\chsat \in \eqso(\loge{2})$. We consider the signature $\R$ that we used as the encoding for a Horn formula (Example \ref{ex-hornsat-esop1}) and that the formula $\alpha \in \eqso(\loge{2})$ follows the encoding in the same way. From what we proved in Theorem \ref{theo-pnf-snf}, we have that every formula in $\eqso(\loge{2})$ can be rewritten in $\loge{2}$-PNF, so we assume that $\alpha$ is in this form. Let $\alpha = \sa{\bar{X}}\sa{\bar{x}}\exists\bar{y}\,\forall\bar{z}\,\varphi(\bar{X},\bar{x},\bar{y},\bar{z})$. Consider the following Horn formula $\Phi$:
$$
\Phi = p \wedge \bigwedge_{i = 1}^n (t_i \wedge p \to q) \wedge \neg q,
$$
where $n = \length(\bar{x}) + \length(\bar{y}) + 1$. Let $\A$ be the encoding of this formula. In the encoding, each variable appears as an element in the domain of $\A$. This formula is satisfiable, so $\sem{\alpha}(\A) \geq 1$. Let $(\bar{B},\bar{b},\bar{a})$ be an assignment to $(\bar{X},\bar{x},\bar{y})$ such that $\A\models\forall\bar{z}\,\varphi(\bar{B},\bar{b},\bar{a},\bar{z})$. Let $t_{\ell}$ be such that it does not appear in $\bar{b}$ or $\bar{a}$. Consider the induced substructure $\A'$ that is obtained by removing $t_{\ell}$ from $\A$ and $\bar{B}'$ as the subset of $\bar{B}$ obtained by deleting each appearance of $t_{\ell}$ in $\bar{B}$. We have that $\A'\models\forall\bar{z}\,\varphi(\bar{B},\bar{b},\bar{a},\bar{z})$. This is because each subformula of the form $\exists y \neg B_i$ is still true, and universal formulas are monotone over induced substructures. It follows that $\sem{\alpha}(\A') \geq 1$ which is not possible since $\A'$ encodes the formula
$$
\Phi' = p \wedge \bigwedge_{i = 1}^{\ell-1} (t_i \wedge p \to q) \wedge (p\to q) \wedge \bigwedge_{i = \ell+1}^{n} (t_i \wedge p \to q) \wedge \neg q,
$$
which is unsatisfiable. We arrive to a contradiction and we conclude that $\chsat$ is not in $\eqso(\ehorn)$.








\subsection*{Proof of Theorem \ref{sigma2hard}} %V.13

First we prove that $\shdhsat$ is in $\eqso(\ehorn)$. Recall that each instance of $\shdhsat$ is a disjunction of Horn formulas. Let $\R = \{\pP(\cdot,\cdot), \pN(\cdot,\cdot), \pV(\cdot), \pNC(\cdot), \pD(\cdot,\cdot)\}$. Each symbol in this vocabulary is used to indicate the same as in Example \ref{ex-hornsat-esop1}, with the addition of $\pD(d,c)$ which indicates that $c$ is a clause in the formula $d$. Recall that the formula
\begin{align*}
&\forall x \, (\neg \pT(x) \vee \pV(x)) \ \wedge\\
&\forall c \, (\neg \textit{NC}(c) \vee \exists x \, \neg \textit{A}(c,x)) \ \wedge\\
&\forall c \forall x \, (\neg \textit{P}(c,x) \vee \exists y \, \neg \textit{A}(c,y) \vee \textit{T}(x)) \ \wedge\\
&\forall c \forall x \, (\neg \textit{N}(c,x) \vee \textit{T}(x) \vee \neg \textit{A}(c,x)) \ \wedge\\
&\forall c \forall x \, (\textit{A}(c,x) \vee \textit{N}(c,x)) \ \wedge\\
&\forall c \forall x \, (\textit{A}(c,x) \vee \neg\textit{T}(x)).
\end{align*}
defines $\chsat$. We obtain the following formula $\psi(T,A)$ in $\ehorn$:
\begin{align*}
\exists d[&\forall x \, (\neg \pT(x) \vee \pV(x)) \ \wedge\\
&\forall c \, (\neg \pD(c,d)\vee \neg \textit{NC}(c) \vee \exists x \, \neg \textit{A}(c,x)) \ \wedge\\
&\forall c \forall x \, (\neg \pD(c,d)\vee\neg \textit{P}(c,x) \vee \exists y \, \neg \textit{A}(c,y) \vee \textit{T}(x)) \ \wedge\\
&\forall c \forall x \, (\neg \pD(c,d)\vee\neg \textit{N}(c,x) \vee \textit{T}(x) \vee \neg \textit{A}(c,x)) \ \wedge\\
&\forall c \forall x \, (\neg \pD(c,d)\vee\textit{A}(c,x) \vee \textit{N}(c,x)) \ \wedge\\
&\forall c \forall x \, (\neg \pD(c,d)\vee\textit{A}(c,x) \vee \neg\textit{T}(x))]
\end{align*}
effectively defines $\chsat$ as for every disjunction of Horn formulas $\theta = \theta_1\vee\cdots\vee\theta_m$ encoded by an $\R$-structure $\A$, the number of satisfying assignments of $\theta$ is equal to $\sem{\sa{\pT} \sa{\pA} \psi(\pT,\pA)}(\A)$.  Therefore, we conclude that $\shdhsat \in \eqso(\ehorn)$.

\vspace{1em}
We will now prove that $\shdhsat$ is hard for $\eqso$ over a signature $\R$ under parsimonious reductions. For each $\eqso(\ehorn)$ formula $\alpha$ over $\R$, we will define a polynomial-time procedure that computes a function $g_{\alpha}$. This function receives a finite $\R$-structure $\A$ and outputs an instance of $\shdhsat$ such that $\sem{\alpha}(\A) = \shdhsat(g_{\alpha}(\A))$. We suppose that $\alpha$ is in sum normal form and:
$$
\alpha = \sum_{i = 1}^{\text{\#clauses}} \sa{\bar{X}}\sa{\bar{x}}\exists\bar{y}\bigwedge_{j = 1}^{n}\forall\bar{z}\,\varphi^i_j(\bar{X},\bar{x},\bar{y},\bar{z}),
$$
where each $\varphi^i_j$ is a Horn clause.                                                                

Consider a finite $\R$-structure $\A$ with domain $A$. To simplify the proof, we extend our grammar to allow first-order constants. Consider each tuple $\bar{a}\in A^{\length(\bar{x})}$, each $\bar{b}\in A^{\length(\bar{y})}$ and each $\bar{c}\in A^{\length(\bar{z})}$ as a tuple of first-order constants. The following formula defines the same function as $\alpha$:
$$
\sum_{i = 1}^{\#clauses} \sum_{\bar{a}\in A^{\length(\bar{x})}} \sa{\bar{X}}\bigvee_{\bar{b}\in A^{\length(\bar{y})}}\bigwedge_{j = 1}^{n}\bigwedge_{\bar{c}\in A^{\length(\bar{z})}}\varphi^i_j(\bar{X},\bar{a},\bar{b},\bar{c}).
$$
Note that each $\fo$ formula over $(\bar{x},\bar{y},\bar{z})$ in each $\varphi^i_j$ has no free variables. Therefore, we can evaluate each of these in polynomial time and replace them by $\perp$ and $\top$ where it corresponds. Each $\varphi^i_j$ will be of the form $\perp \vee\, \chi^i_j(\bar{X})$ or $\top \vee \chi^i_j(\bar{X})$ where $\chi^i_j$ is a disjunction of $\neg X_{\ell}$'s and at most one $X_{\ell}$. The formulas of the form $\top \vee \chi^i_j(\bar{X})$ can be removed entirely, and the formulas of the form $\perp \vee\, \chi^i_j(\bar{X})$ can be replaced by $\chi^i_j(\bar{X})$. We obtain the formula
$$
\sum_{i = 1}^{m}\sa{\bar{X}}\bigvee_{j = 1}^{\#d}\bigwedge_{k = 1}^{\#c}\psi^{i}_{j,k}(\bar{X})
$$
where every $\psi^{i}_{j,k}(\bar{X})$ is a disjunction of $\neg X_{\ell}$'s and zero or one $X_{\ell}$.

Our idea for the rest of the proof is to define $g_{\alpha}$ for each $\alpha = \sa{\bar{X}}\bigvee_{j = 1}^{\#d}\bigwedge_{k = 1}^{\#c}\psi^{i}_{j,k}(\bar{X})$, for $\alpha = c$ and for $\alpha = \beta_1 + \cdots + \beta_m$ where each $\beta_i$ is in one of the two previous cases.

If $\alpha$ is equal to $\sa{\bar{X}}\bigvee_{j = 1}^{\#d}\bigwedge_{k = 1}^{\#c}\psi_{j,k}(\bar{X})$ where $\psi_{j,k}(\bar{X})$ is a disjunction of $\neg X_{\ell}$'s and zero or one $X_{\ell}$, then we obtain the {\bf propositional formula} $g_{\alpha}(\A) = \bigvee_{j = 1}^{\#d}\bigwedge_{k = 1}^{\#c}\psi_{j,k}(\bar{X})$ over the propositional alphabet $\{X(\bar{e}) \mid X \in \bar{X} \text{ and } \bar{e}\in A^{\arity(X)} \}$ which has exactly $\sem{\alpha}(\A)$ satisfying assignments and is precisely a disjunction of Horn formulas.

If $\alpha$ is equal to a constant $c$, then we define $g_{\alpha}(\A)$ as the following formula that has exactly $c$ satisfying assignments:
$$
g_{\alpha}(\A) = \bigvee_{i = 1}^{c}\neg t_1 \wedge \cdots \wedge \neg t_{i-1} \wedge t_i \wedge \neg t_{i+1} \wedge \cdots \wedge \neg p_c.
$$ 
If $\alpha = \beta_1 + \cdots + \beta_m$, let $g_{\beta_i}(\A) = \bigvee_{j = 1}^{\#d}\bigwedge_{k = 1}^{\#c}\theta^i_{j,k}$ for each $\beta_i$ where each $\theta^i_{j,k}$ is a Horn clause. Let $\Theta_i = g_{\beta_i}(\A)$. We rename the variables in each $\Theta_i$ so none of them are mentioned in any other $\Theta_j$. We add $m$ new variables $t_1,\ldots,t_m$ and we define:
\begin{align*}
g_{\alpha}(\A) = &\bigvee_{i = 1}^{\#d}(\bigwedge_{j = 1}^{\#c}\theta^1_{i,j} \wedge (\bigwedge\limits_{\substack{\text{each } t\\ \text{ mentioned in}\\ \Theta_2,\ldots,\Theta_{m}}}t) \wedge (t_1 \wedge \bigwedge_{\ell = 2}^{m} \neg t_{\ell})) \vee \\ 
&\bigvee_{i = 1}^{\#d}(\bigwedge_{j = 1}^{\#c}\theta^2_{i,j} \wedge (\bigwedge\limits_{\substack{\text{each $t$}\\ \text{ mentioned in}\\ \Theta_1,\Theta_3,\ldots,\Theta_{m}}}t) \wedge (t_2 \wedge \bigwedge\limits_{\substack{\ell = 1 \\ \ell \neq 2}}^{m} \neg t_{\ell})) \vee \cdots \vee\\ 
&\bigvee_{i = 1}^{\#d}(\bigwedge_{j = 1}^{\#c}\theta^m_{i,j} \wedge (\bigwedge\limits_{\substack{\text{each } t\\ \text{ mentioned in}\\ \Theta_2,\ldots,\Theta_{m-1}}}t) \wedge (t_m \wedge \bigwedge_{\ell = 1}^{m-1} \neg t_{\ell})).
\end{align*}
The formula is a disjunction of Horn formulas, and the number of satisfying assignments for this formula is exactly the sum of satisfying assignments for each $g_{\beta_i}(\A)$. This, at the same time, is equal to $\sem{\alpha}(\A)$. This covers all possible cases for $\alpha$, and the entire procedure takes polynomial time.