
\medskip

%%% DEMOSTRACION DE SQSO(FO) y #P
\subsection*{Proof of Proposition~\ref{prop:capture-shP}}

We will construct a recursive non-deterministic algorithm $M_{\alpha}$ for each $\eqso(\fo)$ formula $\alpha$ over a signature $\R$. This machine, on input $(\A,v,V)$ accepts in $\sem{\alpha}(\A,v,V)$ of its non-deterministic paths for each $(\A,v,V) \in \ostr[\R]^*$. Suppose $\A$ has domain $A$. If $\alpha$ is a $\fo$-formula $\varphi$, then the algorithm checks if $(\A,v,V)\models\varphi$ deterministically in polynomial time, and accepts if and only if it holds true. If $\alpha$ is a constant $s$, it produces $s$ branches and accepts in all of them. If $\alpha = (\beta \add \gamma)$, then it chooses between 0 or 1, if it is 0 (1), it simulates $M_{\beta}$ ($M_{\gamma}$) on input $(\A,v,V)$. 
%If $\alpha = (\beta \mult \gamma)$, it simulates $M_{\beta}$ on input $(\A,v,V)$ and on each accepting path, it continues simulating $M_{\gamma}$ on input $(\A,v,V)$.
If $\alpha = \sa{x}\beta$, it chooses $a\in A$ and simulates $M_{\beta}$ on input $(\A,v[a/x],V)$.
%If $\alpha = \pa{x}\beta$, it simulates $M_{\beta}$ on input $(\A,v[a/x],V)$ consecutively for each $a\in A$. 
If $\alpha = \sa{X}\beta$, it chooses $B\in A^{arity(X)}$ and simulates $M_{\beta}$ on input $(\A,v,V[B/X])$. This covers all possible cases for $\alpha$. Let $\alpha$ be a formula in $\eqso(\fo)$ over a signature $\R$ and let $f$ be a function over $\R$ such that $f(\enc(\A))$ is equal to the accepting paths of $M_{\alpha}$ on input $(\A,v,V)$ for some $(\A,v,V) \in \ostr[\R]^*$. We have that $f$ is a $\shp$-function over $\R$ and $f(\enc(\A)) = \sem{\alpha}(\A)$ for every $\A\in\ostr[\R]$.

For the other direction, note that Saluja et al.~\cite{SalujaST95} proved that $\shp = \sfo$. 
%We also have that $\sqso(\fo)$ captures $\#\fo$ over ordered structures so for each $f\in \shp$ let $\alpha \in \sqso(\fo)$ be its corresponding formula. 
Since a function in $\sfo$ can also be defined $\eqso(\fo)$ (see Section~\ref{sec:previous}), the condition holds. \qed

\medskip

%%% DEMOSTRACION DE SQSO(ESO) y span-P
\subsection*{Proof of Proposition~\ref{prop:capture-spanP}}

Similar than the previous proof, we will construct a recursive non-deterministic algorithm $M_{\alpha}$ for each $\eqso(\eso)$ formula $\alpha$ over a signature $\R$. This machine, on input $(\A,v,V)$, non-deterministically produces $\sem{\alpha}(\A,v,V)$ distinct accepting outputs for each $(\A,v,V) \in \ostr[\R]^*$. Suppose $\A$ has domain $A$. 
If $\alpha$ is a $\eso$-formula $\varphi$ it checks if $(\A,v,V)\models\varphi$ non-deterministically in polynomial time \cite{fagin1974generalized}, and accepts if and only if the condition holds true. 
If $\alpha$ is a constant $s$, then the algorithm produces $s$ branches and accepts in all of them. 
If $\alpha = (\beta \add \gamma)$, then it chooses between 0 or 1, if it is 0 (1), it simulates $M_{\beta}$ ($M_{\gamma}$) on input $(\A,v,V)$.  
If $\alpha = \sa{x}\beta$, it chooses $a\in A$ and simulates $M_{\beta}$ on input $(\A,v[a/x],V)$. 
If $\alpha = \sa{X} \beta$, it chooses $B\in A^{\arity(X)}$ and simulates $M_{\beta}$ on input $(\A,v,V[B/X])$. 
This covers all possible cases for $\alpha$.
Additionally, the algorithm produces a different output on each path. This can be done by printing the trace of all the non-deterministic choices.
However, when the algorithm starts checking whether $(\A,v,V)\models\varphi$ for some $\eso$ formula $\varphi$, it stops printing in the output tape. This way the algorithm produces exactly one output from that point onwards.
Let $\alpha$ be a formula in $\eqso(\eso)$ over a signature $\R$ and let $f$ be a function over $\R$ such that $f(\enc(\A))$ is equal to the number of accepting outputs of $M_{\alpha}$ on input $(\A,v,V)$ for some $(\A,v,V) \in \ostr[\R]^*$. 
We have that $f$ is a $\spp$ function over $\R$ and that $f(\enc(\A)) = \sem{\alpha}(\A)$ for every $\A\in\ostr[\R]$.

For the other direction, Compton et al.~\cite{ComptonG96} proved that $\spp = \#\eso$. Since a function in $\#\eso$ can also be defined in $\eqso(\eso)$, then $\eqso(\eso)$ captures $\spp$ over ordered structures. \qed

\medskip

%%% DEMOSTRACION DE QFO(LFP) y FP
\subsection*{Proof of Theorem~\ref{theo:capture-fp}}

For the first condition, let $\alpha\in\qfo(\lfp)$ over some signature $\R$. Let $f$ be a function over $\R$ defined by the following procedure. Let $\enc(\A)$ be an input, where $\A$ is an ordered structure over $\R$ with domain $A = \{a_1,\ldots,a_n\}$. Replace each first order sum and first order product in $\alpha$ by an expansion using the elements in $A$. This is, $\Sigma x \beta(x)$ is replaced by $(\beta(a_1)+\cdots+\beta(a_n))$ and $\Pi x \beta(x)$ is replaced by $(\beta(a_1)\cdot\,\cdots\,\cdot\beta(a_n))$. Then each sub-formula $\varphi\in\lfp$ in $\alpha$ is replaced by 1 if $\A\models\varphi$ and by 0 otherwise. The resulting formula is an arithmetic expression of polynomial size which is evaluated and lastly given as output. Note that $f\in\fp$ and $f(\enc(\A)) = \sem{\alpha}(\A)$.
	
For the second condition, let $f\in \fp$ defined over some signature $\R$. Let $\ell\in\nat$ be such that for each $\A\in\ostr[\R]$, $\lceil\log_2 f(\enc(\A)) \rceil \leq n^\ell$, where $\A$ has a domain of size $n$. Let $\Phi(x_0,\ldots,x_{\ell-1})$ be a formula that represents the following. Let $\A$ be an ordered structure over $\R$ with domain $A$. Consider a linear order over $A^{\ell}$ given by $\bar{a} < \bar{b}$, for any $\bar{a},\bar{b}\in A^{\ell}$. Let $w$ be a string of size $n^{\ell}$ the represents $f(\enc(\A))$ in binary. Let $(a_1,\ldots,a_{\ell})\in A^{\ell}$ be the $m$-th tuple in the given order (starting from 0). $\A\models\Phi(a_1,\ldots,a_{\ell})$ if an only if the $m$-th bit in $w$ is 1, from least to most significant. Since this condition can be computed in polynomial time, and $\lfp$ captures $\ptime$, this formula can be expressed in $\lfp$. We use
$$
\alpha = \sa{x_1} \cdots \sa{x_{\ell}} \Phi(x_1,\ldots,x_{\ell})\cdot\varphi(x_1,\ldots,x_{\ell}),
$$
where $\varphi(x_1,\ldots,x_{\ell}) := \pa{y_1}\cdots\pa{y_{\ell}}((y_1,\ldots,y_{\ell}) < (x_1,\ldots,x_{\ell}) \mapsto 2).$ Note that if $\bar{a} \in A^{\ell}$ is the $m$-th tuple in the given order (starting from 0), then $\sem{\varphi(\bar{a})}(\A) = 2^{m}$. Adding these values for each $\bar{a}\in A^{\ell}$ gives exactly $f(\enc(\A))$. Then, $\alpha$ is in $\qfo(\lfp)$ over $\R$ and $\sem{\alpha}(\A) = f(\enc(\A))$. \qed
\medskip

%%% DEMOSTRACION DE QSO(PFP) y FPSPACE
\subsection*{Proof of Theorem~\ref{theo:capture-fpspace}}

To show how to evaluate a $\qso(\pfp)$-formula, we will construct a recursive non-deterministic algorithm $M_{\alpha}$ for each $\qso(\pfp)$ formula $\alpha$ over a signature $\R$. This machine runs in non-deterministic polynomial space and, on input $(\A,v,V)$, accepts in $\sem{\alpha}(\A,v,V)$ of its non-deterministic paths for each $(\A,v,V) \in \ostr[\R]^*$. Suppose $\A$ has domain $A$. If $\alpha$ is a $\pfp$-formula $\varphi$, then the algorithm checks if $(\A,v,V)\models\varphi$ deterministically in polynomial space~\cite{L04}, and accepts if and only if it holds true. If $\alpha$ is a constant $s$, it produces $s$ branches and accepts in all of them. If $\alpha = (\beta \add \gamma)$, then it chooses between 0 or 1, if it is 0 (1), it simulates $M_{\beta}$ ($M_{\gamma}$) on input $(\A,v,V)$. If $\alpha = (\beta \mult \gamma)$, it simulates $M_{\beta}$ on input $(\A,v,V)$ and on each accepting path, it continues simulating $M_{\gamma}$ on input $(\A,v,V)$.
If $\alpha = \sa{x}\beta$, it chooses $a\in A$ and simulates $M_{\beta}$ on input $(\A,v[a/x],V)$. If $\alpha = \pa{x}\beta$, it simulates $M_{\beta}$ on input $(\A,v[a/x],V)$ consecutively for each $a\in A$. If $\alpha = \sa{X}\beta$, it chooses $B\in A^{arity(X)}$ and simulates $M_{\beta}$ on input $(\A,v,V[B/X])$. If $\alpha = \pa{X}\beta$, it simulates $M_{\beta}$ on input $(\A,v,V[B/X])$ consecutively for each $B\in A^{arity(X)}$. This covers all possible cases for $\alpha$, and each of these steps can be computed in polynomial space. Let $\alpha$ be a formula in $\qso(\pfp)$ over a signature $\R$ and let $f$ be a function over $\R$ such that $f(\enc(\A))$ is equal to the accepting paths of $M_{\alpha}$ on input $(\A,v,V)$ for some $(\A,v,V) \in \ostr[\R]^*$. We have that $f$ is a $\shpspace$ function over $\R$, which implies that $f$ is also a $\fpspace$ function over $\R$, by the fact that $\shpspace = \fpspace$ \cite{Ladner89}, and that $f(\enc(\A)) = \sem{\alpha}(\A)$ for every $\A\in\ostr[\R]$.
\cristian{Aca debes explicar mejor que hace la máquina. Es un copy paste de demostraciones anteriores y no queda claro porque puedes evaluar la formula en FPSPACE. Tampoco queda claro porque puedes usar no determinismo en FPSPACE.} \martin{es un copy-paste porque hice la demostración para $\shpspace$, lo dejé un poco más claro ahora}

For the second condition, let $f\in \fpspace$ defined over some $\R$. Let $\ell\in\nat$ be such that for each $\A\in\ostr[\R]$, $\lceil\log_2 f(\enc(\A)) \rceil \leq 2^{n^\ell}$, where $\A$ has a domain of size $n$. Let $\Phi(X)$ be a $\pfp$ formula that represents the following. Consider an order over the subsets of $A^{\ell}$ given by the formula $$\varphi_{<}(X,Y) = \exists\bar{u}\big[\neg X(\bar{u})\wedge Y(\bar{u})\wedge \forall\bar{v}\big(
\bar{u}<\bar{v}\to(X(\bar{u})\iff Y(\bar{v}))\big)\big].$$ 

Let $B$ be the $p$-th subset with respect to this order and let $w$ be a string of size $2^{n^{\ell}}$ which represents the value of $f(\enc(\A))$ in binary. Then $\A\models\Phi(B)$ if and only if the $p$-th bit in $w$ is 1, from least to most significant. Since this condition can be verified in polynomial space, and $\pfp$ captures $\pspace$, then $\Phi$ can be expressed in $\pfp$. We define
$\alpha := \sa{X}(\Phi(X)\mult\varphi(X))$, where $\varphi(X) = \pa{Y}(\varphi_{<}(Y,X)\mapsto 2)$. Note that for each $B\subseteq A^{\ell}$ such that $B$ is the $m$-th element in the given order, $\sem{\varphi(B)}(\A) = 2^m$. Therefore, $\alpha\in\qso(\pfp)$ and $\sem{\alpha}(\A) = f(\enc(\A))$. \qed

\medskip


%%% DEMOSTRACION DE QFO(PFP) y FPSPACE(poly)
\subsection*{Proof of Corollary~\ref{cor:capture-fpspace-poly}}

\martin{no revisar, voy a hacer un copy paste del teorema \ref{theo:capture-fp} cuando este listo}

Let $\alpha\in\qfo(\pfp)$ over some $\R$. Let $f$ be a function over $\R$ defined by the following procedure. Let $\enc(\A)$ be an input, where $\A$ is an ordered structure over $\R$ with domain $A = \{a_1,\ldots,a_n\}$. Replace each first order sum and first order product in $\alpha$ by an expansion using the elements in $A$. This is, $\Sigma x \beta(x)$ is replaced by $(\beta(a_1)+\cdots+\beta(a_n))$ and $\Pi x \beta(x)$ is replaced by $(\beta(a_1)\cdot\,\cdots\,\cdot\beta(a_n))$. Then each sub-formula $\varphi\in\pfp$ in $\alpha$ is replaced by 1 if $\A\models\varphi$ and by 0 otherwise.
\cristian{Explicar porque puedes hacer esto en FPSPACE(poly)}
The resulting formula is an arithmetic expression of polynomial size which is evaluated and lastly given as output. Note that $f\in\nfpspace$ and $f(\enc(\A)) = \sem{\alpha}(\A)$.

Now, let $f\in \nfpspace$ defined over some $\R$. Let $\ell\in\nat$ be such that for each $\A\in\ostr[\R]$, $\lceil\log_2 f(\enc(\A)) \rceil \leq n^\ell$, where $\A$ has a domain of size $n$. Let $\Phi(x_0,\ldots,x_{\ell-1})$ be a $\pfp$ formula that represents the following. For each $\A \in \ostr[\R]$, for convenience, suppose its domain is $A = \{0,\ldots,n-1\}$ with the usual order. Let $y$ be a string of size $n^{\ell}$ that represents the value of $f(\enc(\A))$ in binary. Then, for each $\ell$-tuple $(a_0,\ldots,a_{\ell-1}) \in A^{\ell}$, it holds that $\A \models \Phi(a_0,\ldots,a_{\ell-1})$ if and only if the $(n^{\ell-1}a_{\ell-1} + \cdots + n^2 a_2 + n a_1 + a_0)$-th bit of $y$, from least to most significant, is 1. We use
$$
\alpha = \Sigma x_0 \cdots \Sigma x_{\ell-1} \Phi(x_0,\ldots,x_{\ell-1})\cdot\varphi_{\ell-1}(x_{\ell-1})\cdot\,\cdots\,\cdot\varphi_0(x_0).
$$
where $\varphi_i(x) = \Pi y[(y < x)\mapsto\Pi z_1\cdots\Pi z_i\,2]$ for $i > 0$ and $\varphi_0(x) = \Pi y[(y < x)\mapsto 2]$. Let $\A$ the previously defined structure. Note that for each $a\in A$, then $\sem{\varphi_i(x)}(\A,a) = 2^{n^i a}$. Therefore, for each $(a_0,\ldots,a_{\ell-1})\in A^\ell$, we have that
$$
\sem{\Phi(x_0,\ldots,x_{\ell-1})\cdot\varphi_{\ell-1}(x_{\ell-1})\,\cdots\,\varphi_0(x_0)}(\A,a_0,\ldots,a_{\ell-1}) = 
\begin{cases}
2^{(n^{\ell-1}a_{\ell-1} + \cdots + n^2 a_2 + n a_1 + a_0)} &\text{if } (\A,a_0,\ldots,a_{\ell-1})\models\Phi \\
0 &\text{otherwise.}
\end{cases}
$$
and adding these values gives $f(\enc(\A))$. Then, $\alpha$ is in $\qfo(\pfp)$ over $\R$ and $\sem{\alpha}(\A) = f(\enc(\A))$. \qed